{% import 'macros/back_fchart_navig_macros.html' as back_fchart_navig %}

{% macro fchart(fchart_url, fchart_img_url, fchart_legend_url, fchart_pdf_url, fchart_items_url, fchart_form, default_chart_iframe_url='', embed='', search_url_params='', obj_ra='',
                obj_dec='', back=none, back_id=none, default_back=none, back_anchor=none, disable_to_detail=False, fchart_scene_url=none) %}

<style>
    .ui.button.custom-nav {
      border: none;
      box-shadow: none;
      margin: 0px;
    }

    .ui.icon.button.custom-nav {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
      height: 56px;
      width: 24px;
    }

    .ui.inverted.button.custom-nav,
    .ui.inverted.button.custom-nav:hover,
    .ui.inverted.button.custom-nav:focus,
    .ui.inverted.button.custom-nav:active {
      color: {{ '#cacbcc' if chart_control.theme!='night' else '#ae8f8f' }};
      background-color: {{ '#383c4a' if chart_control.theme!='night' else '#211010' }};
      box-shadow: none !important;
    }

    .ui.button.round-right-only {
      border-top-left-radius: 0px;
      border-bottom-left-radius: 0px;
      border-top-right-radius: 6px;
      border-bottom-right-radius: 6px;
    }

    .ui.button.round-left-only {
      border-top-left-radius: 6px;
      border-bottom-left-radius: 6px;
      border-top-right-radius: 0px;
      border-bottom-right-radius: 0px;
    }
    @media (hover: none), (pointer: coarse) {
      [data-tooltip]::before,
      [data-tooltip]::after {
        display: none !important;
      }
    }
</style>

<div id="fchart-div" style="width:100%;height:75vh;background:{{ '#fff' if chart_control.theme=='light' else ('#020202' if chart_control.theme=='night' else '#03030A') }}">
    <div id="top-menu" class="ui secondary menu">

        <div id="bhome" class="ui horizontally fitted computer tablet only item" style="z-index:100;display:none;margin-left:16px;">
            <a class="ui small icon button" href="{{ url_for('main.index') }}" data-inverted="" data-tooltip="{{ _('Home') }}" data-position="bottom left" data-variation="tiny basic">
                <i class="home icon"></i>
            </a>
        </div>

        {{ back_fchart_navig.back_navig(back, back_id, default_back, false, back_anchor, 'bback', ' computer tablet only') }}

        {% if default_chart_iframe_url and not disable_to_detail %}
            <div id="bdetail" class="ui horizontally fitted computer tablet only item" style="z-index:100;display:none;">
                <a class="ui small icon button" data-inverted="" data-tooltip="{{ _('Detail') }}" data-position="bottom left" data-variation="tiny basic"
                   onclick="window.location.href=removeParamFromRelativeUrl('{{ default_chart_iframe_url }}', 'embed');">
                    <i class="external alternate icon"></i>
                </a>
            </div>
        {% endif %}

        <form id="fmchart" action="{{ fchart_url }}" method="post" class="right menu">
            <input type="hidden" id="ra" name="ra" value="{{ fchart_form.ra.data }}" >
            <input type="hidden" id="dec" name="dec" value="{{ fchart_form.dec.data }}" >
            <input type="hidden" id="az" name="az" value="{{ fchart_form.az.data }}" >
            <input type="hidden" id="alt" name="alt" value="{{ fchart_form.alt.data }}" >
            <input type="hidden" id="longitude" name="{{ fchart_form.longitude.name }}" value="{{ fchart_form.longitude.data }}">
            <input type="hidden" id="latitude" name="{{ fchart_form.latitude.name }}" value="{{ fchart_form.latitude.data }}">
            <input type="hidden" id="chart_date_time" name="{{ fchart_form.chart_date_time.name }}" value="{{ fchart_form.chart_date_time.data }}">
            <input type="hidden" id="use_current_time" name="{{ fchart_form.use_current_time.name }}" value="{{ fchart_form.use_current_time.data }}">
            <input type="hidden" id="fullscreen" name="fullscreen" value="{{ fchart_form.fullscreen.data }}" >
            <input type="hidden" id="splitview" name="splitview" value="{{ fchart_form.splitview.data }}" >
            <input type="hidden" id="radius" name="{{ fchart_form.radius.name }}" value="{{ fchart_form.radius.data }}">
            <input type="hidden" id="show_telrad" name="{{ fchart_form.show_telrad.name }}" value="{{ fchart_form.show_telrad.data }}">
            <input type="hidden" id="show_picker" name="{{ fchart_form.show_picker.name }}" value="{{ fchart_form.show_picker.data }}">
            <input type="hidden" id="show_constell_shapes" name="{{ fchart_form.show_constell_shapes.name }}" value="{{ fchart_form.show_constell_shapes.data }}">
            <input type="hidden" id="show_constell_borders" name="{{ fchart_form.show_constell_borders.name }}" value="{{ fchart_form.show_constell_borders.data }}">
            <input type="hidden" id="show_dso" name="{{ fchart_form.show_dso.name }}" value="{{ fchart_form.show_dso.data }}">
            <input type="hidden" id="show_milky_way" name="{{ fchart_form.show_milky_way.name }}" value="{{ fchart_form.show_milky_way.data }}">
            <input type="hidden" id="show_solar_system" name="{{ fchart_form.show_solar_system.name }}" value="{{ fchart_form.show_solar_system.data }}">
            <input type="hidden" id="show_comet_tail" name="{{ fchart_form.show_comet_tail.name }}" value="{{ fchart_form.show_comet_tail.data }}">
            <input type="hidden" id="show_dso_mag" name="{{ fchart_form.show_dso_mag.name }}" value="{{ fchart_form.show_dso_mag.data }}">
            <input type="hidden" id="show_star_lbl" name="{{ fchart_form.show_star_labels.name }}" value="{{ fchart_form.show_star_labels.data }}">
            <input type="hidden" id="show_egrid" name="{{ fchart_form.show_equatorial_grid.name }}" value="{{ fchart_form.show_equatorial_grid.data }}">
            <input type="hidden" id="show_hgrid" name="{{ fchart_form.show_horizontal_grid.name }}" value="{{ fchart_form.show_horizontal_grid.data }}">
            <input type="hidden" id="dss_layer" name="{{ fchart_form.dss_layer.name }}" value="{{ fchart_form.dss_layer.data }}">
            <input type="hidden" id="eyepiece_fov" name="{{ fchart_form.eyepiece_fov.name }}" value="{{ fchart_form.eyepiece_fov.data }}">
            <input type="hidden" id="mirror_x" name="{{ fchart_form.mirror_x.name }}" value="{{ fchart_form.mirror_x.data }}" >
            <input type="hidden" id="mirror_y" name="{{ fchart_form.mirror_y.name }}" value="{{ fchart_form.mirror_y.data }}" >
            <input type="hidden" id="optimize_traffic" name="{{ fchart_form.optimize_traffic.name }}" value="{{ fchart_form.optimize_traffic.data }}" >
            <input type="hidden" id="is_equatorial" name="{{ fchart_form.is_equatorial.name }}" value="{{ fchart_form.is_equatorial.data }}">

            {% if chart_control.has_date_from_to %}
                <div class="ui horizontally fitted mobile hidden item" style="z-index:100;">
                    <div class="chart-popup ui small icon button" data-inverted="" data-tooltip="{{ _('Interval') }}" data-position="left center" data-variation="inverted tiny basic">
                        <i class="calendar icon"></i>
                    </div>
                    <div class="ui popup transition hidden">
                        <div class="item">
                            <div class="ui calendar" id="cal_date_from">
                                <div class="ui small input left icon">
                                    <i class="calendar icon"></i>
                                    <input name="{{ fchart_form.date_from.name }}" placeholder="Date" type="text"
                                            value="{{ fchart_form.date_from.data.strftime('%d/%m/%Y') if fchart_form.date_from.data else ''}}">
                                </div>
                            </div>
                            <div class="ui left pointing label">
                               {{ _('Date From') }}
                            </div>
                        </div>
                        <div class="item">
                            <div class="ui calendar" id="cal_date_to">
                                <div class="ui small input left icon">
                                    <i class="calendar icon"></i>
                                    <input name="{{ fchart_form.date_to.name }}" placeholder="Date" type="text"
                                            value="{{ fchart_form.date_to.data.strftime('%d/%m/%Y') if fchart_form.date_to.data else ''}}">
                                </div>
                            </div>
                            <div class="ui left pointing label">
                               {{ _('Date To') }}
                            </div>
                        </div>
                    </div>
                </div>
            {% endif %}

            <div class="ui right horizontally fitted small monitor item" style="z-index:100">
                <div id="viewcenter_dropdown" class="ui small icon dropdown icon button" data-inverted="" data-tooltip="{{ _('View center settings') }}" data-position="left center" data-variation="tiny basic">
                    <i class="crosshairs icon"></i>
                    <div class="ui vertical buttons menu">
                        <div class="item">
                            <button id="bcenterobj" type="button" class="ui toggle labeled tiny icon button" style="text-align:left">
                                <i class="crosshairs icon"></i>
                                {{ _('Center object') }}
                            </button>
                        </div>
                        <div class="item">
                            <button id="btelrad" type="button" class="ui toggle labeled tiny icon button{{ ' active' if fchart_form.show_telrad.data=='true' else ''}}" style="text-align:left" >
                                <i class="bullseye icon"></i>
                                {{ _('Telrad') }}
                            </button>
                        </div>
                        <div class="item">
                            <button id="bpicker" type="button" class="ui toggle labeled tiny icon button{{ ' active' if fchart_form.show_picker.data=='true' else ''}}" style="text-align:left">
                                <i class="square outline icon"></i>
                                {{ _('Picker') }}
                            </button>
                        </div>
                        {% if chart_control.equipment_telescopes %}
                            {% for telescope in chart_control.equipment_telescopes %}
                                <div class="item submenu-parent-item">
                                    <button class="ui tiny labeled icon button submenu-parent-trigger"  style="text-align:left">
                                        <i class="binoculars icon"></i>
                                        <span class="text">{{ telescope.name }} <i class="dropdown icon"></i></span>
                                    </button>
                                    <div class="right menu">
                                        {% for eyepiece in chart_control.equipment_eyepieces %}
                                            <div class="item" onclick="setEyepieceFov({{ telescope.get_fov(eyepiece) }})">
                                                {{ eyepiece.name }}
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            {% endfor %}
                            <div class="item">
                                <button type="button" class="ui labeled tiny icon button" style="text-align:left" onclick="unselectFov()">
                                    <i class="toggle off icon"></i>
                                    {{ _('Unselect') }}
                                </button>
                            </div>
                        {% endif %}
                        <div class="item">
                            <button id="bhelp" type="button" class="ui labeled tiny icon button" style="text-align:left">
                                <i class="question circle icon"></i>
                                {{ _('Help') }}
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="ui right horizontally fitted small item" style="z-index:100;">
                <div class="chart-popup ui small icon button" data-inverted="" data-tooltip="{{ _('Setup time') }}" data-position="left center" data-variation="inverted tiny basic">
                    <i class="icons">
                        <i class="clock outline icon"></i>
                        <i class="map marker alternate inverted corner icon"></i>
                    </i>
                </div>
                <div class="ui popup hidden" style="z-index:200;">
                    <div class="field" style="margin-bottom: 10px;">
                        <div class="ui inverted toggle checkbox">
                            <input type="checkbox" id="cb_use_current_time" {% if fchart_form.use_current_time.data=='true'%}checked{% endif %}/>
                            <label>{{ _('Use current time') }}</label>
                        </div>
                    </div>

                    <div class="fields" style="display: flex; flex-wrap: nowrap; align-items: center;">
                        <!-- Year Field -->
                        <div class="field" style="margin: 0;">
                            <div class="ui small icon button increment-year"><i class="chevron up icon"></i></div>
                            <div class="ui transparent input">
                                <input id="yearInput" value="2025" inputmode="numeric" style="text-align: center; width: 40px;" />
                            </div>
                            <div class="ui small icon button decrement-year"><i class="chevron down icon"></i></div>
                        </div>

                        <span style="font-size: 1.2em;">-</span>

                        <!-- Month Field -->
                        <div class="field" style="margin: 0;">
                            <div class="ui small icon button increment-month"><i class="chevron up icon"></i></div>
                            <div class="ui transparent input">
                                <input id="monthInput" value="1" style="text-align: center; width: 40px;" />
                            </div>
                            <div class="ui small icon button decrement-month"><i class="chevron down icon"></i></div>
                        </div>

                        <span style="font-size: 1.2em;">-</span>

                        <!-- Day Field -->
                        <div class="field" style="margin: 0;">
                            <div class="ui small icon button increment-day"><i class="chevron up icon"></i></div>
                            <div class="ui transparent input">
                                <input id="dayInput" value="1" style="text-align: center; width: 40px;" />
                            </div>
                            <div class="ui small icon button decrement-day"><i class="chevron down icon"></i></div>
                        </div>

                        <span style="width: 15px;"></span>

                        <!-- Hour Field -->
                        <div class="field" style="margin: 0;">
                            <div class="ui small icon button increment-hour"><i class="chevron up icon"></i></div>
                            <div class="ui transparent input">
                                <input id="hourInput" value="0" style="text-align: center; width: 40px;" />
                            </div>
                            <div class="ui small icon button decrement-hour"><i class="chevron down icon"></i></div>
                        </div>

                        <span style="font-size: 1.2em;">:</span>

                        <!-- Minute Field -->
                        <div class="field" style="margin: 0;">
                            <div class="ui small icon button increment-minute"><i class="chevron up icon"></i></div>
                            <div class="ui transparent input">
                                <input id="minuteInput" value="0" style="text-align: center; width: 40px;" />
                            </div>
                            <div class="ui small icon button decrement-minute"><i class="chevron down icon"></i></div>
                        </div>

                        <span style="font-size: 1.2em;">:</span>

                        <!-- Second Field -->
                        <div class="field" style="margin: 0;">
                            <div class="ui small icon button increment-second"><i class="chevron up icon"></i></div>
                            <div class="ui transparent input">
                                <input id="secondInput" value="0" style="text-align: center; width: 40px;" />
                            </div>
                            <div class="ui small icon button decrement-second"><i class="chevron down icon"></i></div>
                        </div>
                    </div>
                    <div class="field" style="margin-top: 10px;">
                        <div id="cal_chart_date_time" class="ui calendar" style="">
                            <div class="ui small input left icon">
                                <i class="calendar icon"></i>
                                <input name="chart_date_time_helper" placeholder="Date" type="text"
                                       value="{{ fchart_form.chart_date_time.data[:16].replace('T',' ') if fchart_form.chart_date_time.data else '' }}">
                            </div>
                        </div>
                    </div>
                    <div class="field" style="margin-top: 10px;">
                        <label>{{ _('Current Location') }} :<span id="location_city_name">{{ session.get('location_city_name', _('Unknown city')) }}</span></label>

                    </div>
                    <div class="field" style="margin-top: 10px;">
                        <div class="ui inverted toggle checkbox" data-inverted=""  data-position="bottom center" data-variation="tiny basic"
                             data-tooltip="{{ _('We use your IP temporarily to show accurate maps. It is processed in real time and not stored. ') }}">
                            <input type="checkbox" id="cb_use_auto_location" {% if fchart_form.use_auto_location.data=='true'%}checked{% endif %}/>
                            <label>{{ _('Use auto location') }}</label>
                        </div>
                    </div>
                    <div class="field" style="margin-top: 10px;">
                        <div class="ui search selection {{ 'disabled' if fchart_form.use_auto_location.data=='true' else '' }} dropdown dlocation">
                            <input type="hidden" id="location" name="{{ fchart_form.user_location.name }}" value="{{ fchart_form.user_location.data }}">
                            <i class="dropdown icon"></i>
                            <input type="text" class="search">
                            <div class="default text">{{ _('Location') }}</div>
                        </div>
                        {% if fchart_form.user_location.errors %}
                            <div class="ui red pointing label">
                                {{ fchart_form.user_location.errors[0] | safe }}
                            </div>
                        {% endif %}
                        <label style="margin-left: 10px;">{{ _('User location') }}</label>
                    </div>
                </div>
            </div>

            <div class="ui right horizontally fitted small item" style="z-index:100">
                <div id="layers_dropdown" class="ui small icon dropdown icon button" data-inverted="" data-tooltip="{{ _('Settings') }}" data-position="left center" data-variation="tiny basic">
                    <i class="layer group icon"></i>
                    <div class="ui vertical buttons menu">
                        <div class="item">
                            <button id="bequatorial" type="button" class="ui toggle labeled tiny icon button{{ ' active' if fchart_form.is_equatorial.data=='true' else ''}}" style="text-align:left">
                                <i class="globe icon"></i>
                                {{ _('Equat â†” Horizontal')}}
                            </button>
                        </div>
                        <div class="item">
                            <button id="bconstellshapes" type="button" class="ui toggle labeled tiny icon button{{ ' active' if fchart_form.show_constell_shapes.data=='true' else ''}}" style="text-align:left">
                                <i class="lastfm icon"></i>
                                {{ _('Constellation lines') }}
                            </button>
                        </div>
                        <div class="item">
                            <button id="bconstellborders" type="button" class="ui toggle labeled tiny icon button{{ ' active' if fchart_form.show_constell_borders.data=='true' else ''}}" style="text-align:left">
                                <i class="draw polygon icon"></i>
                                {{ _('Constellation borders')}}
                            </button>
                        </div>
                        <div class="item">
                            <button id="begrid" type="button" class="ui toggle labeled tiny icon button{{ ' active' if fchart_form.show_equatorial_grid.data=='true' else ''}}" style="text-align:left">
                                <i class="globe icon"></i>
                                {{ _('Equatorial grid')}}
                            </button>
                        </div>
                        <div class="item">
                            <button id="bhgrid" type="button" class="ui toggle labeled tiny icon button{{ ' active' if fchart_form.show_horizontal_grid.data=='true' else ''}}" style="text-align:left">
                                <i class="globe icon"></i>
                                {{ _('Horizontal grid')}}
                            </button>
                        </div>
                        <div class="item submenu-parent-item">
                            <button class="ui tiny labeled icon button submenu-parent-trigger" style="text-align:left">
                                    <i class="sun icon"></i>
                                <span class="text">{{ _('Sol. system') }}<i class="dropdown icon"></i></span>
                            </button>
                            <div class="right menu">
                                <div class="item">
                                    <button id="bslsystem" type="button" class="ui toggle labeled tiny icon button{{ ' active' if fchart_form.show_solar_system.data=='true' else ''}}" style="text-align:left">
                                        <i class="sun icon"></i>
                                        {{ _('SS bodies')}}
                                    </button>
                                </div>
                                <div class="item">
                                    <button id="bcomettail" type="button" class="ui toggle labeled tiny icon button{{ ' active' if fchart_form.show_comet_tail.data=='true' else ''}}" style="text-align:left">
                                        <i class="meteor icon"></i>
                                        {{ _('Comet tail')}}
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="item submenu-parent-item">
                            <button class="ui tiny labeled icon button submenu-parent-trigger" style="text-align:left">
                                <i class="globe icon"></i>
                                <span class="text">{{ _('Distant universe') }}<i class="dropdown icon"></i></span>
                            </button>
                            <div class="right menu">
                                <div class="item">
                                    <button id="bdso" type="button" class="ui toggle labeled tiny icon button{{ ' active' if fchart_form.show_dso.data=='true' else ''}}" style="text-align:left">
                                        <i class="superpowers icon"></i>
                                        {{ _('Deepsky objects')}}
                                    </button>
                                </div>
                                <div class="item">
                                    <button id="bmilkyway" type="button" class="ui toggle labeled tiny icon button{{ ' active' if fchart_form.show_milky_way.data=='true' else ''}}" style="text-align:left">
                                        <i class="globe icon"></i>
                                        {{ _('Milky way') }}
                                    </button>
                                </div>
                                <div class="item">
                                    <button id="bdsomag" type="button" class="ui toggle labeled tiny icon button{{ ' active' if fchart_form.show_dso_mag.data=='true' else ''}}" style="text-align:left">
                                        <i class="star of life icon"></i>
                                        {{ _('DSO mag')}}
                                    </button>
                                </div>
                                <div class="item">
                                    <button id="bstarlbl" type="button" class="ui toggle labeled tiny icon button{{ ' active' if fchart_form.show_star_labels.data=='true' else ''}}" style="text-align:left">
                                          <i class="star outline icon"></i>
                                          {{ _('Star labels')}}
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="item div_aladin submenu-parent-item">
                            <button class="ui tiny labeled icon button submenu-parent-trigger"  style="text-align:left">
                                <i class="image outline icon"></i>
                                <span class="text">Aladin<i class="dropdown icon"></i></span>
                            </button>
                            <div class="right menu">
                                <div class="item div_dsscolored">
                                    <button id="bdsscolored" type="button" class="ui toggle labeled tiny icon button{{ ' active' if fchart_form.dss_layer.data=='colored' else ''}}" style="text-align:left">
                                        <i class="image outline icon"></i>
                                        {{ _('Aladin color') }}
                                    </button>
                                </div>
                                {% if chart_control.theme!='night' %}
                                <div class="item div_dssblue">
                                    <button id="bdssblue" type="button" class="ui toggle labeled tiny icon button{{ ' active' if fchart_form.dss_layer.data=='blue' else ''}}" style="text-align:left">
                                        <i class="image outline icon"></i>
                                        {{ _('Aladin blue') }}
                                    </button>
                                </div>
                                <div class="item div_dssfram">
                                    <button id="bdssfram" type="button" class="ui toggle labeled tiny icon button{{ ' active' if fchart_form.dss_layer.data=='fram' else ''}}" style="text-align:left">
                                        <i class="image outline icon"></i>
                                        {{ _('Aladin fram') }}
                                    </button>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="item submenu-parent-item">
                            <button class="ui tiny labeled icon button submenu-parent-trigger"  style="text-align:left">
                                <i class="map palette icon"></i>
                                <span class="text">{{ _('Chart Themes') }}<i class="dropdown icon"></i></span>
                            </button>
                            <div class="right menu">
                                <div class="item" onclick="setTheme('dark')">{{ _('Dark Mode') }}</div>
                                <div class="item" onclick="setTheme('light')">{{ _('Light Mode') }}</div>
                                <div class="item" onclick="setTheme('night')">{{ _('Night Mode') }}</div>
                                {% for t in current_user.user_themes %}
                                    <div class="item" onclick="setCustomTheme({{ t.id }})">{{ t.name }}</div>
                                {% endfor %}
                            </div>
                        </div>

                        <div class="item">
                            <button id="mirrorx" type="button" class="ui toggle labeled tiny icon button{{ ' active' if fchart_form.mirror_x.data=='true' else ''}}" style="text-align:left">
                                <i class="exchange alternate icon"></i>
                                {{ _('Flip horizontally')}}
                            </button>
                        </div>
                        <div class="item">
                            <button id="mirrory" type="button" class="ui toggle labeled tiny icon button{{ ' active' if fchart_form.mirror_y.data=='true' else ''}}" style="text-align:left">
                                <i class="clockwise rotated  exchange alternate icon"></i>
                                {{ _('Flip vertically')}}
                            </button>
                        </div>
                        <div class="item">
                            <button id="boptitraffic" type="button" class="ui toggle labeled tiny icon button{{ ' active' if fchart_form.optimize_traffic.data=='true' else ''}}" style="text-align:left" >
                                <i class="wifi icon"></i>
                                {{ _('Optimize traffic')}}
                            </button>
                        </div>
                        <div class="item">
                            <button id="bperfmeter" type="button" class="ui toggle labeled tiny icon button active" style="text-align:left">
                                <i class="chart line icon"></i>
                                {{ _('Perf. meter')}}
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Star mag limit -->
            <div class="ui horizontally fitted item" style="z-index:100">
                <div class="ui small icon dropdown button" data-inverted="" data-tooltip="{{ _('Limit mag') }}" data-position="left center" data-variation="tiny basic">
                    <input type="hidden" id="maglim" name="maglim" value="{{ fchart_form.maglim.data }}" >
                    <span id="smaglim" class="text">{{ fchart_form.maglim.data }}</span>
                    <div id="maglim_menu" class="menu">
                        {% for mag_item in range(chart_control.mag_scale[0], chart_control.mag_scale[1] + 1) %}
                            <div class="item">{{ mag_item }}</div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- dso mag limit -->
            <div class="ui horizontally fitted item" style="z-index:100">
                <div class="ui small icon dropdown button"  data-inverted="" data-tooltip="{{ _('DSO limit mag') }}" data-position="left center" data-variation="tiny basic">
                    <input type="hidden" id="dso_maglim" name="dso_maglim" value="{{ fchart_form.dso_maglim.data }}">
                    <span id="sdso_maglim" class="text">{{ fchart_form.dso_maglim.data }}</span>
                    <div id="dso_maglim_menu" class="menu">
                        {% for mag_item in range(chart_control.dso_mag_scale[0], chart_control.dso_mag_scale[1] + 1) %}
                            <div class="item">
                                {{ mag_item }}
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </form>

        <!-- Export to PDF -->
        {% if fchart_pdf_url is not none %}
            <div class="ui horizontally fitted item mobile hidden" style="z-index:100">
                <div class="ui floating small icon dropdown button" data-inverted="" data-tooltip="{{ _('PDF export') }}" data-position="left center" data-variation="tiny basic">
                    <i class="download icon"></i>
                    <div class="menu">
                        {% if fchart_items_url is not none %}
                            <div class="item">
                                <i class="dropdown icon"></i>
                                <span class="text">Landscape</span>
                                <div class="right menu">
                                    <a id="download_pdf_landscape" class="item" href="" target="_blank" data-position="bottom center" data-variation="tiny basic">Download PDF</a>
                                    <a id="download_items_landscape" class="item" href="" target="_blank" data-position="bottom center" data-variation="tiny basic">Items</a>
                                </div>
                            </div>
                            <div class="item">
                                <i class="dropdown icon"></i>
                                <span class="text">Portrait</span>
                                <div class="right menu">
                                    <a id="download_pdf_portrait" class="item" href="" target="_blank" data-position="bottom center" data-variation="tiny basic">Download PDF</a>
                                    <a id="download_items_portrait" class="item" href="" target="_blank" data-position="bottom center" data-variation="tiny basic">Items</a>
                                </div>
                            </div>
                        {% else %}
                            <a id="download_pdf_landscape" class="item" href="" target="_blank" data-position="bottom center" data-variation="tiny basic">Landscape</a>
                            <a id="download_pdf_portrait" class="item" href="" target="_blank" data-position="bottom center" data-variation="tiny basic">Portrait</a>
                        {% endif %}
                    </div>
                </div>
            </div>
        {% endif %}

        <div id="isearch" class="ui horizontally fitted small item computer tablet only" style="width: 150px; z-index:100; display:none;">
            <div class="ui icon input">
                <input id="search" name="search" class="search search-dso" type="text" placeholder="{{ _('Search...') }} ">
                <i class="search icon"></i>
            </div>
        </div>

        <div class="ui horizontally fitted item" style="margin-right:16px; z-index:100">
            <div class="ui small buttons">
                <button id="bfullscreen" type="button" class="ui icon button">
                    <i class="expand icon"></i>
                </button>
            </div>
        </div>
    </div>

    <div id="right-menu" class="ui vertical icon right floated mobile only menu" style="margin-right:8px;">
        <a id="bhome_mob" class="ui small icon button item" href="{{ url_for('main.index') }}" data-inverted=""
           data-tooltip="{{ _('Home') }}" data-position="bottom left" data-variation="tiny basic"
           style="z-index:100;margin-bottom:8px;">
            <i class="home {{ 'inverted' if chart_control.theme!='light' else ''}} icon"></i>
        </a>

        {{ back_fchart_navig.back_navig_inner(back, back_id, default_back, false, back_anchor, 'bback_mob', ' item', 'z-index:100;margin-bottom:8px;', ' inverted' if chart_control.theme!='light' else '') }}

        {% if default_chart_iframe_url and not disable_to_detail %}
            <a id="bdetail_mob" class="ui small icon button item" data-inverted="" data-tooltip="{{ _('Detail') }}" data-position="bottom left" data-variation="tiny basic"
               style="z-index:100;" onclick="window.location.href=removeParamFromRelativeUrl('{{ default_chart_iframe_url }}', 'embed');">
                <i class="external alternate {{ 'inverted' if chart_control.theme!='light' else '' }} icon"></i>
            </a>
        {% endif %}
    </div>

    <div class="ui" style="position: absolute; top: 0; bottom: 0; display: flex; align-items: center;">
        <button id="bhideleftpanel" type="button" class="ui icon {{ '' if chart_control.theme=='light' else 'inverted' }} button custom-nav round-right-only" style="z-index:100;display:none" >
            <i class="angle left icon"></i>
        </button>
        <button id="bshowleftpanel1" type="button" class="ui icon {{ '' if chart_control.theme=='light' else 'inverted' }} button custom-nav round-right-only mobile hidden" style="z-index:100;display:none;">
            <i class="angle right icon"></i>
        </button>
    </div>

    <div class="ui" style="position: absolute; top: 0; bottom: 0; right: 0; display: flex; align-items: center;">
        <button id="bshowleftpanel2" type="button" class="ui icon {{ '' if chart_control.theme=='light' else 'inverted' }} button custom-nav round-left-only mobile only" style="z-index:100;display:none;">
            <i class="angle left icon"></i>
        </button>
    </div>

    <div id="isearch2" class="ui tablet hidden computer hidden input" style="z-index:100; position: absolute; bottom: 0; right:0; display:none;">
        <div id="iisearch2" class="ui tiny input transition hidden" style="width:150px; margin-right: 0.5em;">
            <input id="iiisearch2" name="search" type="text" class="search search-dso" placeholder="{{ _('Search...') }}">
        </div>
        <button class="ui tiny icon button" id="bsearch2">
            <i class="search icon"></i>
        </button>
    </div>

    {% assets 'aladin_css' %}<link rel="stylesheet" type="text/css" href="{{ ASSET_URL }}">{% endassets %}
    <div class="aladin-logo-container tablet hidden computer hidden" style="z-index:100;bottom: 35px">
        <a href="http://aladin.unistra.fr/" title="Powered by Aladin Lite" target="_blank"><div class="aladin-logo aladin-logo-small"></div></a>
    </div>
    <div class="aladin-logo-container mobile hidden" style="z-index:100;">
        <a href="http://aladin.unistra.fr/" title="Powered by Aladin Lite" target="_blank"><div class="aladin-logo aladin-logo-large" style="width: 90px;"></div></a>
    </div>
</div>

<div id="fchart-aladin-div" style="position:fixed;left:-9999px; top:-9999px; z-index:0;">
</div>

<div class="ui tiny modal fchartHelpModal" style="z-index:10000;">
    <div class="header">{{ _('Help') }}</div>
    <div class="content">
        <h4 class="ui dividing header">{{ _('Map controls') }}</h4>
        <div class="ui relaxed list">
            <div class="item"><strong>{{ _('Arrows / drag with left mouse button') }}</strong> - {{ _('move sky view') }}</div>
            <div class="item"><strong>{{ _('PgUp / PgDown') }}</strong> - {{ _('zoom out / zoom in') }}</div>
            <div class="item"><strong>{{ _('Left click') }}</strong> - {{ _('select object') }}</div>
            <div class="item"><strong>{{ _('Double click') }}</strong> - {{ _('center view') }}</div>
        </div>
        <h4 class="ui dividing header">{{ _('Keyboard shortcuts') }}</h4>
        <div class="ui relaxed list">
            <div class="item"><strong>e</strong> - {{ _('toggle equatorial grid') }}</div>
            <div class="item"><strong>z</strong> - {{ _('toggle horizontal grid') }}</div>
            <div class="item"><strong>b</strong> - {{ _('toggle constellation borders') }}</div>
            <div class="item"><strong>c</strong> - {{ _('toggle constellation lines') }}</div>
            <div class="item"><strong>d, n</strong> - {{ _('toggle deep-sky objects') }}</div>
            <div class="item"><strong>i</strong> - {{ _('toggle Aladin background') }}</div>
            <div class="item"><strong>p</strong> - {{ _('toggle solar system objects') }}</div>
            <div class="item"><strong>s</strong> - {{ _('toggle star labels') }}</div>
            <div class="item"><strong>{{ _('Space') }}</strong> - {{ _('center object') }}</div>
            <div class="item"><strong>t</strong> - {{ _('toggle Telrad') }}</div>
            <div class="item"><strong>F1</strong> - {{ _('open help') }}</div>
        </div>
    </div>
    <div class="actions">
        <button type="button" class="ui right labeled icon approve button">
            {{ _('Close') }}
            <i class="checkmark icon"></i>
        </button>
    </div>
</div>

{% if chart_control.show_not_found %}
    <div class="ui tiny modal notFoundModal" style="z-index:10000;">
        <div class="header">{{ _('Object not found') }}</div>
        <div class="content">
            <p>{{ _('Specified object was not found.') }}</p>
        </div>
        <div class="actions">
            <a class="ui right labeled icon approve button" href="#" onclick="$('.ui.modal.notFoundModal').modal('hide')">
               {{ _('Close') }}
               <i class="checkmark icon"></i>
          </a>
        </div>
    </div>
<style>
.modals.page {
  z-index: 10000 !important;
}
</style>
{% endif %}

<style>
.custom-icon-button {
    display: flex;
    align-items: center;
    justify-content: flex-start;
    padding: 0.5em 1em;
    text-align: left;
}
.custom-button-image {
    height: 16px;
    width: 16px;
    margin-right: 0.5em;
    object-fit: contain;
}
.ui.vertical.menu {
  border: none;
  box-shadow: none;
}
{% if chart_control.theme!='night' %}
.ui.active.toggle.button {
  background-color: #2185d0 !important;
}
{% endif %}
</style>

{% assets 'aladin_js' %}<script type="text/javascript" src="{{ ASSET_URL }}"></script>{% endassets %}
{% assets 'astro_js' %}<script type="text/javascript" src="{{ ASSET_URL }}"></script>{% endassets %}

<script type="text/javascript" src="{{ url_for('static', filename='js/fchart.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='js/sky_scene_view_state.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='js/sky_scene_stars_renderer.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='js/sky_scene_dso_renderer.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='js/sky_scene_planet_renderer.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='js/sky_scene_constell_renderer.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='js/sky_scene_milkyway_renderer.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='js/sky_scene_grid_renderer.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='js/sky_scene_nebulae_outlines_renderer.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='js/sky_scene_horizon_renderer.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='js/sky_scene_info_panel_renderer.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='js/sky_scene_highlight_renderer.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='js/sky_scene_projection.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='js/sky_scene.js') }}"></script>

<script type="text/javascript">
    const fullScreenWrapperId = 'fullscreen-wrapper';
    var chartPdfUrl = "{{ fchart_pdf_url | safe }}";

    function isWebGL2Supported() {
        try {
            var canvas = document.createElement('canvas');
            return !!canvas.getContext('webgl2');
        } catch (e) {
            return false;
        }
    }

    function addCommonChartUrlParams(url, commonParams) {
        const queryStartIndex = url.indexOf('?');

        if (queryStartIndex === -1) {
            return url + "?" + commonParams;
        } else {
            const baseUrl = url.substring(0, queryStartIndex);
            const existingQuery = url.substring(queryStartIndex + 1);
            return baseUrl + "?" + commonParams + "&" + existingQuery;
        }
    }

    const PERF_METER_STORAGE_KEY = 'sky_scene_perf_meter_enabled';

    function isPerfMeterEnabled() {
        try {
            const raw = window.localStorage.getItem(PERF_METER_STORAGE_KEY);
            if (raw === null) return true;
            return raw === '1';
        } catch (e) {
            return true;
        }
    }

    function persistPerfMeterEnabled(enabled) {
        try {
            window.localStorage.setItem(PERF_METER_STORAGE_KEY, enabled ? '1' : '0');
        } catch (e) {}
    }

    function applyPerfMeterStateToChart(chartObj) {
        if (!chartObj) return;
        chartObj.debugPerfOverlay = isPerfMeterEnabled();
        if (typeof chartObj.requestDraw === 'function') {
            chartObj.requestDraw();
        }
    }

    function syncPerfMeterButton() {
        const enabled = isPerfMeterEnabled();
        $('#bperfmeter').toggleClass('active', enabled);
    }

    function createFChart(fieldSizes, isEquatorial, phi, theta, obj_ra, obj_dec,
                          longitude, latitude, useCurrentTime, chartDateTimeISO,
                          theme, legendUrl, chartUrl, sceneUrl, aladin, projection, fullScreenWrapperId) {
        var showAladin = (aladin != null) && {{ 'true' if fchart_form.dss_layer.data in ['colored', 'blue', 'fram'] else 'false' }};
        $('.aladin-logo-container').toggle(showAladin);

        var searchUrl = "{{ url_for('main.global_search') }}?q=__SEARCH__{{ (('&' + search_url_params) if search_url_params else '') |safe}}";
        var fchart = null;
        if (useDataMode && sceneUrl) {
            fchart = new SkyScene(
                '#fchart-div',
                {{ fchart_form.radius.data }},
                fieldSizes,
                isEquatorial,
                phi,
                theta,
                obj_ra,
                obj_dec,
                longitude,
                latitude,
                useCurrentTime,
                chartDateTimeISO,
                theme,
                legendUrl,
                chartUrl,
                sceneUrl,
                searchUrl,
                {{ 'true' if fchart_form.fullscreen.data == 'true' else 'false' }},
                {{ 'true' if fchart_form.splitview.data == 'true' else 'false' }},
                {{ 'true' if fchart_form.mirror_x.data == 'true' else 'false' }},
                {{ 'true' if fchart_form.mirror_y.data == 'true' else 'false' }},
                '{{ default_chart_iframe_url }}',
                '{{ embed }}',
                aladin,
                showAladin,
                projection
            );
        } else {
            fchart = new FChart(
                '#fchart-div',
                {{ fchart_form.radius.data }},
                fieldSizes,
                isEquatorial,
                phi,
                theta,
                obj_ra,
                obj_dec,
                longitude,
                latitude,
                useCurrentTime,
                chartDateTimeISO,
                theme,
                legendUrl,
                chartUrl,
                searchUrl,
                {{ 'true' if fchart_form.fullscreen.data == 'true' else 'false' }},
                {{ 'true' if fchart_form.splitview.data == 'true' else 'false' }},
                {{ 'true' if fchart_form.mirror_x.data == 'true' else 'false' }},
                {{ 'true' if fchart_form.mirror_y.data == 'true' else 'false' }},
                '{{ default_chart_iframe_url }}',
                '{{ embed }}',
                aladin,
                showAladin,
                projection
            );
        }

        fchart.onFieldChange(function(fldSizeIndex) {
            submitDisabled = true;
            $('#radius').val(fldSizeIndex);
            $('#maglim').val(magRangeValues[fldSizeIndex]);
            $('#dso_maglim').val(dsoMagRangeValues[fldSizeIndex]);
            $('#smaglim').text(magRangeValues[fldSizeIndex].toString());
            $('#sdso_maglim').text(dsoMagRangeValues[fldSizeIndex].toString());

            $('#maglim_menu').empty();
            for (var i = magRanges[fldSizeIndex][0]; i <= magRanges[fldSizeIndex][1]; i++) {
                $('<div class="item" data-value="'+ i +'">' + i +'</div>').appendTo('#maglim_menu');
            }

            $('#dso_maglim_menu').empty();
            for (var j = dsoMagRanges[fldSizeIndex][0]; j <= dsoMagRanges[fldSizeIndex][1]; j++) {
                $('<div class="item" data-value="'+ j +'">' + j +'</div>').appendTo('#dso_maglim_menu');
            }

            submitDisabled = false;
        });

        fchart.onScreenModeChange(function(fullScreen, splitView, realFullScreen) {
            $('#fullscreen').val(fullScreen);
            $('#splitview').val(splitView);

            if (splitView) {
                $("#bhideleftpanel").show();
                $("#bshowleftpanel1, #bshowleftpanel2").hide();
                if (window.innerWidth > 768) {
                    $("#isearch, #isearch2, #bhome").show();
                } else {
                    $("#top-menu, #right-menu, #isearch2").hide();
                }
                $("#bback, #bdetail").show();
            } else {
                $("#top-menu, #right-menu").show();
                if (fullScreen) {
                    $("#bshowleftpanel1, #bshowleftpanel2, #isearch, #isearch2, #bhome").show();
                    $("#bback, #bdetail").show();
                    $("#bhideleftpanel").hide();
                } else {
                    $("#bshowleftpanel1, #bshowleftpanel2, #bhideleftpanel, #isearch2").hide();
                    $("#bhome, #bback, #bdetail").hide();
                }
            }
            let popupContext = realFullScreen ? '#' + fullScreenWrapperId : 'body';
            $('.chart-popup').popup('hide');
            $('.chart-popup').popup('destroy');
            $('.chart-popup').popup({
                on: 'click',
                inline: true,
                context : popupContext
            });
            updateDateTimeControls($('#cb_use_current_time').prop('checked'));
        });

        fchart.onChartTimeChanged(function(chartTimeISO) {
            $('#chart_date_time').val(chartTimeISO);
            syncDateTimeComponentsInputs(true);
        });

        fchart.onShortcutKey(function(key, event) {
            const keyActionMap = {
                e: 'toggle_egrid',
                z: 'toggle_hgrid',
                b: 'toggle_constell_borders',
                c: 'toggle_constell_shapes',
                d: 'toggle_dso',
                n: 'toggle_dso',
                i: 'toggle_aladin',
                p: 'toggle_solar_system',
                s: 'toggle_star_labels',
                t: 'toggle_telrad',
            };
            const actionButtonMap = {
                toggle_egrid: '#begrid',
                toggle_hgrid: '#bhgrid',
                toggle_constell_borders: '#bconstellborders',
                toggle_constell_shapes: '#bconstellshapes',
                toggle_dso: '#bdso',
                toggle_solar_system: '#bslsystem',
                toggle_star_labels: '#bstarlbl',
                center_object: '#bcenterobj',
                toggle_telrad: '#btelrad',
            };
            const dssButtonMap = {
                colored: '#bdsscolored',
                blue: '#bdssblue',
                fram: '#bdssfram',
            };
            let action = keyActionMap[key];
            if (!action && (key === ' ' || key === 'spacebar' || event.keyCode === 32)) {
                action = 'center_object';
            }
            if (!action) {
                return false;
            }

            if (action === 'toggle_aladin') {
                if (!isEquatorial || !isWebGL2Supported()) {
                    return false;
                }
                const currentLayer = $('#dss_layer').val();
                if (currentLayer !== '' && dssButtonMap[currentLayer]) {
                    $(dssButtonMap[currentLayer]).trigger('click');
                    return true;
                }
                const layerToEnable = ['colored', 'blue', 'fram'].includes(lastAladinLayer) ? lastAladinLayer : 'colored';
                $(dssButtonMap[layerToEnable]).trigger('click');
                return true;
            }

            const buttonSelector = actionButtonMap[action];
            if (!buttonSelector) {
                return false;
            }
            $(buttonSelector).trigger('click');
            return true;
        });

        applyPerfMeterStateToChart(fchart);

        return fchart;
    }

    function adjustAladinVisibility() {
        if (!isEquatorial || !isWebGL2Supported()) {
            $('.div_aladin').hide();
            $('.div_dsscolored').hide();
            $('.div_dssblue').hide();
            $('.div_dssfram').hide();
        } else {
            $('.div_aladin').show();
            $('.div_dsscolored').show();
            $('.div_dssblue').show();
            $('.div_dssfram').show();
        }
    }

    function extractMaglimArray(response) {
        let maglimObj = response.data.maglim;
        let maglimArr = [];
        for (let i = 0; i < Object.keys(maglimObj).length; i++) {
            if (maglimObj.hasOwnProperty(i)) {
                maglimArr.push(maglimObj[i]);
            }
        }
        return maglimArr;
    }

    function getChartPdfUrl() {
        if (isEquatorial) {
            return addCommonChartUrlParams(chartPdfUrl, "ra=_RA_&dec=_DEC_&fsz=_FSZ_&dt=_DATE_TIME_");
        } else {
            return addCommonChartUrlParams(chartPdfUrl, "alt=_ALT_&az=_AZ_&fsz=_FSZ_&dt=_DATE_TIME_");
        }
    }

    const SURVEY_OPTIONS = {
      blue: {
        id: "DSS2-blue",
        name: "DSS2 (Blue)",
        url: "P/DSS2/blue"
      },
      fram: {
        id: "CTA-FRAM-color",
        name: "CTA-FRAM (Color)",
        url: "P/CTA-FRAM/survey/color"
      },
      colored: {
        id: "DSS2-color",
        name: "DSS2 (Color)",
        url: "P/DSS2/color"
      }
    };

    var submitDisabled = false;
    var fieldSizes = [{{ chart_control.gui_field_sizes }}];
    var magRanges = [
        {% for mr in chart_control.mag_ranges %} [{{ mr[0] ~ ',' ~ mr[1] }}], {% endfor %}
    ];
    var magRangeValues = [
        {% for mrv in chart_control.mag_range_values %}{{ mrv }}, {% endfor %}
    ];
    var dsoMagRanges = [
        {% for mr in chart_control.dso_mag_ranges %} [{{ mr[0] ~ ',' ~ mr[1] }}], {% endfor %}
    ];
    var dsoMagRangeValues = [
        {% for mrv in chart_control.dso_mag_range_values %}{{ mrv }}, {% endfor %}
    ];

    var phi, theta;
    var obj_ra = {{ obj_ra if obj_ra else 'null' }};
    var obj_dec = {{ obj_dec if obj_dec else 'null' }};

    var theme = '{{ chart_control.theme }}';

    var isEquatorial = ($('#is_equatorial').val() == 'true');

    if (isEquatorial) {
        phi = parseFloat($('#ra').val());
        theta = parseFloat($('#dec').val());
    } else {
        phi = parseFloat($('#az').val());
        theta = parseFloat($('#alt').val());
    }
    var longitude = {{ fchart_form.longitude.data }};
    var latitude = {{ fchart_form.latitude.data }};

    {% if fchart_form.use_current_time.data=='true' %}
        var useCurrentTime = true;
        var chartDateTimeISO = new Date().toISOString();
    {% else %}
        var useCurrentTime = false;
        var chartDateTimeISO = new Date('{{ fchart_form.chart_date_time.data }}').toISOString();
    {% endif %}

    var chartUrlParamsEq = "ra=_RA_&dec=_DEC_&fsz=_FSZ_&width=_WIDTH_&height=_HEIGHT_&dt=_DATE_TIME_";
    var chartUrlParamsHoriz = "alt=_ALT_&az=_AZ_&fsz=_FSZ_&width=_WIDTH_&height=_HEIGHT_&dt=_DATE_TIME_";

    var chartUrlEq = addCommonChartUrlParams("{{ fchart_img_url | safe }}", chartUrlParamsEq);
    var legendUrlEq = addCommonChartUrlParams("{{ fchart_legend_url | safe }}", chartUrlParamsEq);
    var chartUrlHoriz = addCommonChartUrlParams("{{ fchart_img_url | safe }}", chartUrlParamsHoriz);
    var legendUrlHoriz = addCommonChartUrlParams("{{ fchart_legend_url | safe }}", chartUrlParamsHoriz);
    var sceneUrlEq = null;
    var sceneUrlHoriz = null;
    {% if fchart_scene_url is not none %}
    sceneUrlEq = addCommonChartUrlParams("{{ fchart_scene_url | safe }}", chartUrlParamsEq);
    sceneUrlHoriz = addCommonChartUrlParams("{{ fchart_scene_url | safe }}", chartUrlParamsHoriz);
    {% endif %}

    function addOrReplaceQueryParamLocal(url, key, value) {
        try {
            const parsed = new URL(url, window.location.origin);
            parsed.searchParams.set(key, value);
            return parsed.pathname + parsed.search + parsed.hash;
        } catch (e) {
            const k = encodeURIComponent(key);
            const v = encodeURIComponent(value);
            if (url.indexOf('?') === -1) {
                return url + '?' + k + '=' + v;
            }
            const re = new RegExp('([?&])' + k + '=[^&]*');
            if (re.test(url)) {
                return url.replace(re, '$1' + k + '=' + v);
            }
            return url + '&' + k + '=' + v;
        }
    }

    var chartUrl = isEquatorial ? chartUrlEq : chartUrlHoriz;
    var legendUrl = isEquatorial ? legendUrlEq : legendUrlHoriz;
    var sceneUrl = isEquatorial ? sceneUrlEq : sceneUrlHoriz;
    var debugStarsMode = new URLSearchParams(window.location.search).get('debug_stars');
    if (sceneUrl && ['preview_only', 'all'].includes(debugStarsMode)) {
        sceneUrlEq = addOrReplaceQueryParamLocal(sceneUrlEq, 'debug_stars', debugStarsMode);
        sceneUrlHoriz = addOrReplaceQueryParamLocal(sceneUrlHoriz, 'debug_stars', debugStarsMode);
        sceneUrl = isEquatorial ? sceneUrlEq : sceneUrlHoriz;
    }
    var chartMode = "{{ request.args.get('mode', 'image') }}";
    var useDataMode = (chartMode === 'data') && !!sceneUrl && isWebGL2Supported();

    {% if fchart_items_url is not none %}
    var chartItemsUrl;
    if (isEquatorial) {
        chartItemsUrl = addCommonChartUrlParams("{{ fchart_items_url | safe }}", "ra=_RA_&dec=_DEC_&fsz=_FSZ_");
    } else {
        chartItemsUrl = addCommonChartUrlParams("{{ fchart_items_url | safe }}", "alt=_ALT_&az=_AZ_&fsz=_FSZ_");
    }
    {% endif %}

    var projection = new Projection();
    var aladin = null;
    var fchart;
    var lastAladinLayer = '{{ fchart_form.dss_layer.data }}';
    if (!['colored', 'blue', 'fram'].includes(lastAladinLayer)) {
        lastAladinLayer = 'colored';
    }

    projection.setProjection(Projection.PROJ_TAN2);

    if (isWebGL2Supported()) {
        const dssLayerData = '{{ fchart_form.dss_layer.data }}';
        A.init.then(() => {
            aladin = A.aladin('#fchart-aladin-div', {
                fov:60,
                target: "0 0 0 0 0 0",
                projection: "STG",
                fullScreen: false,
                showReticle: false,
                showZoomControl:          false,
                showFullscreenControl:    false,
                showLayersControl:        false,
                showGotoControl:          false,
                showSimbadPointerControl: false,
                showShareControl:         false,
                showCatalog:              false,
                showFrame:                false,
                showCooGrid:              false,
                fullScreen:               false,
                log:                      true
            });
            var mirror_x = {{ 'true' if fchart_form.mirror_x.data == 'true' else 'false' }};
            var mirror_y = {{ 'true' if fchart_form.mirror_y.data == 'true' else 'false' }};
            aladin.setViewCenter2NorthPoleAngle(mirror_y ? 180.0 : 0);
            if (['colored', 'blue', 'fram'].includes(dssLayerData)) {
                var surveyOptions = (mirror_x ^ mirror_y) != 0 ? { longitudeReversed: true } : {};
                var surveyConfig = SURVEY_OPTIONS[dssLayerData];
                let customSurvey = aladin.createImageSurvey(surveyConfig.id, surveyConfig.name, surveyConfig.url, 'equatorial', 9, surveyOptions);
                aladin.setImageSurvey(customSurvey);
            }
            fchart = createFChart(fieldSizes, isEquatorial, phi, theta, obj_ra, obj_dec,
                                  longitude, latitude, useCurrentTime, chartDateTimeISO,
                                  theme, legendUrl, chartUrl, sceneUrl, aladin, projection, fullScreenWrapperId);
            fchart.setUseCurrentTime({{ 'true' if fchart_form.use_current_time.data=='true' else 'false' }});
            fchart.onWindowLoad();
        });
    } else {
        fchart = createFChart(fieldSizes, isEquatorial, phi, theta, obj_ra, obj_dec,
                              longitude, latitude, useCurrentTime, chartDateTimeISO,
                              theme, legendUrl, chartUrl, sceneUrl, null, projection, fullScreenWrapperId);
        fchart.setUseCurrentTime({{ 'true' if fchart_form.use_current_time.data=='true' else 'false' }});
        fchart.onWindowLoad();
    }

    adjustAladinVisibility();

    if ({{ 'true' if fchart_form.fullscreen.data == 'true' or fchart_form.splitview.data == 'true' else 'false' }}) {
        $("#isearch, #isearch2, #bhome, #bback, #bdetail").show();
    }

    if ({{ 'true' if fchart_form.splitview.data == 'true' else 'false' }}) {
        $("#bhideleftpanel").show();
    }

    if ({{ 'true' if fchart_form.fullscreen.data == 'true' else 'false' }}) {
        $("#bshowleftpanel1").show();
        $("#bshowleftpanel2").show();
    }

    function setAladinLayer(surveyCustomName) {
        if (surveyCustomName in SURVEY_OPTIONS) {
            if (aladin != null) {
                const surveyConfig = SURVEY_OPTIONS[surveyCustomName] || SURVEY_OPTIONS.colored;
                const longRev = (fchart.isMirrorX() ^ fchart.isMirrorY()) != 0;
                let customSurvey = aladin.createImageSurvey(
                    surveyConfig.id,
                    surveyConfig.name,
                    surveyConfig.url,
                    'equatorial',
                    9,
                    { longitudeReversed: longRev }
                );
                aladin.setImageSurvey(customSurvey);
                aladin.setViewCenter2NorthPoleAngle(fchart.isMirrorY() ? 180.0 : 0);
            }
        }
        fchart.setAladinLayer(surveyCustomName);
    }

    function clearAladinHipsCache() {
        for (const key in SURVEY_OPTIONS) {
            const { id } = SURVEY_OPTIONS[key];
            if (aladin.hipsCache.contains(id)) {
                aladin.hipsCache.delete(id);
            }
        }
    }

    $('#bequatorial').click(function(event){
        event.stopPropagation();
        $(this).toggleClass('active');
        var value = $('#is_equatorial').val() == 'true' ? 'false' : 'true';
        $('#is_equatorial').val(value);
        isEquatorial = (value == 'true');
        chart_param_ajax('chart_is_equatorial', value, 'chart_dss_layer', '');
        updateChartUrls();
        adjustAladinVisibility();
        setChartUrlFlag('Q', value);
        if (!isEquatorial) {
            setAladinLayer('');
        } else {
            setAladinLayer($('#dss_layer').val());
        }
        fchart.reloadImage();
    });

    $('#btelrad').click(function(){
        $(this).toggleClass('active');
        var value = $('#show_telrad').val() == 'true' ? 'false' : 'true';
        $('#show_telrad').val(value);
        $('#eyepiece_fov').val('');
        chart_param_ajax('chart_show_telrad', value);
        setChartUrlFlag('T', value);
        fchart.reloadLegendImage();
    });

    $('#bpicker').click(function(){
        $(this).toggleClass('active');
        var value = $('#show_picker').val() == 'true' ? 'false' : 'true';
        $('#show_picker').val(value);
        chart_param_ajax('chart_show_picker', value);
        setChartUrlFlag('P', value);
        fchart.reloadLegendImage();
    });

    $('#bconstellshapes').click(function(event){
        event.stopPropagation();
        $(this).toggleClass('active');
        var value = $('#show_constell_shapes').val() == 'true' ? 'false' : 'true';
        $('#show_constell_shapes').val(value);
        chart_param_ajax('chart_show_constell_shapes', value);
        setChartUrlFlag('C', value);
        fchart.reloadImage();
    });

    $('#bconstellborders').click(function(event){
        event.stopPropagation();
        $(this).toggleClass('active');
        var value = $('#show_constell_borders').val() == 'true' ? 'false' : 'true';
        $('#show_constell_borders').val(value);
        chart_param_ajax('chart_show_constell_borders', value);
        setChartUrlFlag('B', value);
        fchart.reloadImage();
    });

    $('#begrid').click(function(event){
        event.stopPropagation();
        $(this).toggleClass('active');
        var value = $('#show_egrid').val() == 'true' ? 'false' : 'true';
        $('#show_egrid').val(value);
        chart_param_ajax('chart_show_equatorial_grid', value);
        setChartUrlFlag('E', value);
        if (value == 'true' && $('#show_hgrid').val() == 'true') {
            $('#bhgrid').removeClass('active');
            $('#show_hgrid').val('false');
            chart_param_ajax('chart_show_horizontal_grid', 'false');
            setChartUrlFlag('H', 'false');
        }
        fchart.reloadImage();
    });

    $('#bhgrid').click(function(event){
        event.stopPropagation();
        $(this).toggleClass('active');
        var value = $('#show_hgrid').val() == 'true' ? 'false' : 'true';
        $('#show_hgrid').val(value);
        chart_param_ajax('chart_show_horizontal_grid', value);
        setChartUrlFlag('H', value);
        if (value == 'true' && $('#show_egrid').val() == 'true') {
            $('#begrid').removeClass('active');
            $('#show_egrid').val('false');
            chart_param_ajax('chart_show_equatorial_grid', 'false');
            setChartUrlFlag('E', 'false');
        }
        fchart.reloadImage();
    });

    $('#bperfmeter').click(function(event){
        event.stopPropagation();
        const enabled = !isPerfMeterEnabled();
        persistPerfMeterEnabled(enabled);
        syncPerfMeterButton();
        applyPerfMeterStateToChart(fchart);
    });

    $('#bdso').click(function(event){
        event.stopPropagation();
        $(this).toggleClass('active');
        var value = $('#show_dso').val() == 'true' ? 'false' : 'true';
        $('#show_dso').val(value);
        chart_param_ajax('chart_show_dso', value);
        setChartUrlFlag('D', value);
        fchart.reloadImage();
    });

    $('#bmilkyway').click(function(event){
        event.stopPropagation();
        $(this).toggleClass('active');
        var value = $('#show_milky_way').val() == 'true' ? 'false' : 'true';
        $('#show_milky_way').val(value);
        chart_param_ajax('chart_show_milky_way', value);
        setChartUrlFlag('W', value);
        fchart.reloadImage();
    });

    $('#bslsystem').click(function(event){
        event.stopPropagation();
        $(this).toggleClass('active');
        var value = $('#show_solar_system').val() == 'true' ? 'false' : 'true';
        $('#show_solar_system').val(value);
        chart_param_ajax('chart_show_solar_system', value);
        setChartUrlFlag('O', value);
        fchart.reloadImage();
    });

    $('#bcomettail').click(function(event){
        event.stopPropagation();
        $(this).toggleClass('active');
        var value = $('#show_comet_tail').val() == 'true' ? 'false' : 'true';
        $('#show_comet_tail').val(value);
        chart_param_ajax('chart_show_comet_tail', value);
        setChartUrlFlag('K', value);
        fchart.reloadImage();
    });

    $('#bdsomag').click(function(event){
        event.stopPropagation();
        $(this).toggleClass('active');
        var value = $('#show_dso_mag').val() == 'true' ? 'false' : 'true';
        $('#show_dso_mag').val(value);
        chart_param_ajax('chart_show_dso_mag', value);
        setChartUrlFlag('M', value);
        fchart.reloadImage();
    });

    $('#bstarlbl').click(function(event){
        event.stopPropagation();
        $(this).toggleClass('active');
        var value = $('#show_star_lbl').val() == 'true' ? 'false' : 'true';
        $('#show_star_lbl').val(value);
        chart_param_ajax('chart_show_star_lbl', value);
        setChartUrlFlag('N', value);
        fchart.reloadImage();
    });

    $('#bdsscolored').click(function(event){
        event.stopPropagation();
        $(this).toggleClass('active');
        var value = $('#dss_layer').val() != 'colored' ? 'colored' : '';
        $('#dss_layer').val(value);
        if (value !== '') {
            lastAladinLayer = value;
        }
        if (value !== '') {
            $('#bdssblue').removeClass('active');
            $('#bdssfram').removeClass('active');
        }
        $('.aladin-logo-container').toggle(value !== '');
        chart_param_ajax('chart_dss_layer', value);
        setAladinLayer(value);
    });

    $('#bdssblue').click(function(event){
        event.stopPropagation();
        $(this).toggleClass('active');
        var value = $('#dss_layer').val() != 'blue' ? 'blue' : '';
        $('#dss_layer').val(value);
        if (value !== '') {
            lastAladinLayer = value;
        }
        if (value !== '') {
            $('#bdsscolored').removeClass('active');
            $('#bdssfram').removeClass('active');
        }
        $('.aladin-logo-container').toggle(value !== '');
        chart_param_ajax('chart_dss_layer', value);
        setAladinLayer(value);
    });

    $('#bdssfram').click(function(event){
        event.stopPropagation();
        $(this).toggleClass('active');
        var value = $('#dss_layer').val() != 'fram' ? 'fram' : '';
        $('#dss_layer').val(value);
        if (value !== '') {
            lastAladinLayer = value;
        }
        if (value !== '') {
            $('#bdsscolored').removeClass('active');
            $('#bdssblue').removeClass('active');
        }
        $('.aladin-logo-container').toggle(value !== '');
        chart_param_ajax('chart_dss_layer', value);
        setAladinLayer(value);
    });

    $('#mirrorx').click(function(event){
        event.stopPropagation();
        $(this).toggleClass('active');
        var value = $('#mirror_x').val() == 'true' ? 'false' : 'true';
        $('#mirror_x').val(value);
        setChartUrlFlag('X', value);
        chart_param_ajax('chart_mirror_x', value);
        fchart.setMirrorX(value);
        if ($('#dss_layer').val() != '') {
            clearAladinHipsCache();
            setAladinLayer($('#dss_layer').val());
        } else {
            setAladinLayer('');
        }
        fchart.reloadImage();
    });

    $('#mirrory').click(function(event){
        event.stopPropagation();
        $(this).toggleClass('active');
        var value = $('#mirror_y').val() == 'true' ? 'false' : 'true';
        $('#mirror_y').val(value);
        setChartUrlFlag('Y', value);
        chart_param_ajax('chart_mirror_y', value);
        fchart.setMirrorY(value);
        if ($('#dss_layer').val() != '') {
            clearAladinHipsCache();
            setAladinLayer($('#dss_layer').val());
        } else {
            setAladinLayer('');
        }
        fchart.reloadImage();
    });

    $('#boptitraffic').click(function(event){
        event.stopPropagation();
        $(this).toggleClass('active');
        var value = $('#optimize_traffic').val() == 'true' ? 'false' : 'true';
        $('#optimize_traffic').val(value);
        chart_param_ajax('optimize_traffic', value);
    });

    $('#bcenterobj').click(function(){
        fchart.centerObjectInFov();
    });

    $('#bfullscreen').click(function(){
        fchart.toggleFullscreen();
    });

    $('#bhideleftpanel').click(function(){
        fchart.toggleSplitView();
    });

    $('#bshowleftpanel1').click(function(){
        fchart.toggleSplitView();
    });

    $('#bshowleftpanel2').click(function(){
        fchart.toggleSplitView();
    });

    $('#bhelp').click(function(){
        openFchartHelpModal();
    });

    $('.ui.dropdown').dropdown();

    // Keep Settings dropdown open when clicking submenu parent triggers.
    $('#layers_dropdown').on('click', '.submenu-parent-trigger', function(event) {
        event.preventDefault();
        event.stopPropagation();
    });

    // Keep View center dropdown open when clicking telescope submenu parent triggers.
    $('#viewcenter_dropdown').on('click', '.submenu-parent-trigger', function(event) {
        event.preventDefault();
        event.stopPropagation();
    });

    $('#maglim').change(function() {
        var fldSize = fieldSizes[$('#radius').val()];
        var response = chart_param_ajax('pref_maglim' + fldSize, $('#maglim').val());
        var maglimArr = extractMaglimArray(response);
        if (maglimArr.length == magRangeValues.length) {
            magRangeValues = maglimArr.slice();
        }
        fchart.reloadImage();
    });

    $('#dso_maglim').change(function() {
        var fldSize = fieldSizes[$('#radius').val()];
        var response = chart_param_ajax('pref_dso_maglim' + fldSize, $('#dso_maglim').val());
        var dsoMaglimArr = extractMaglimArray(response);
        if (dsoMaglimArr.length == dsoMagRangeValues.length) {
            dsoMagRangeValues = dsoMaglimArr.slice();
        }
        fchart.reloadImage();
    });

    {% if fchart_pdf_url is not none %}
    $('#download_pdf_landscape').click(function(){
        $('#download_pdf_landscape').attr("href", fchart.formatUrl(getChartPdfUrl() + '&landscape=true'));
    });

    $('#download_pdf_portrait').click(function(){
        $('#download_pdf_portrait').attr("href", fchart.formatUrl(getChartPdfUrl() + '&landscape=false'));
    });
    {% endif %}

    {% if fchart_items_url is not none %}
    $('#download_items_landscape').click(function(){
        $('#download_items_landscape').attr("href", fchart.formatUrl(chartItemsUrl + '&landscape=true'));
    });
    $('#download_items_portrait').click(function(){
        $('#download_items_portrait').attr("href", fchart.formatUrl(chartItemsUrl + '&landscape=false'));
    });
    {% endif %}

    $('#bsearch2').on('click', function() {
        if ($('#iisearch2').hasClass('hidden')) {
            $('#iisearch2').transition({
                animation  : 'fade',
                onComplete : function() {
                  $('#iiisearch2').focus();
                }
            });
        } else {
            $('#iisearch2').transition('fade');
        }
    });

    $('#iiisearch2').on('blur', function() {
        if (!$('#iisearch2').hasClass('hidden')) {
            $('#iisearch2').transition('fade');
        }
    });

    $('.search-dso').on('keydown', function(event) {
        if(event.which === 13) {
            event.preventDefault();
            var url = "{{ url_for('main.global_search') }}?q=" + $(this).val()
                      + "&fromchart=true&seltab=chart"
                      + getFullscreenSplitViewUrlPart("&")
                      + "&back_url=" + encodeURIComponent('{{ chart_control.back_search_url_b64 }}');
            if ($("#use_current_time").val() == 'false') {
                url += "&dt=" + $('#chart_date_time').val();
            }
            window.location.href = encodeURI(url);
        }
    });

    $('#cal_date_from').calendar({
        type: 'date',
        monthFirst: false,
        endCalendar: $('#cal_date_to'),
        formatter: {
            date: function (date, settings) {
                if (!date) return '';
                let day = date.getDate();
                let month = date.getMonth() + 1;
                let year = date.getFullYear();
                return day + '/' + month + '/' + year;
            }
        },
    });

    $('#cal_date_to').calendar({
        type: 'date',
        monthFirst: false,
        startCalendar: $('#cal_date_from'),
        formatter: {
            date: function (date, settings) {
                if (!date) return '';
                let day = date.getDate();
                let month = date.getMonth() + 1;
                let year = date.getFullYear();
                return day + '/' + month + '/' + year;
            }
        },
        onChange: function () {
            $(this).closest('form').submit();
        }
    });

    $('#cal_chart_date_time').calendar({
        type: 'datetime',
        monthFirst: false,
        ampm: false,
        formatter: {
            date: function (date, settings) {
                if (!date) return '';
                let day = date.getDate();
                let month = date.getMonth() + 1;
                let year = date.getFullYear();
                return year + '-' + month + '-' + day;
            }
        },
        onChange: function(date, text, mode) {
            if (date) {
                $('#chart_date_time').val(date.toISOString());
                syncDateTimeComponentsInputs(false);
                if (fchart) {
                    fchart.setDateTimeISO(date.toISOString());
                    fchart.reloadImage();
                }
            }
        }
    });

    function ensureFlagsParam(url){
        if(!/[\?&]flags=/.test(url)){
            return url + (url.includes('?') ? '&' : '?') + 'flags=';
        }
        return url;
    }
    function addFlag(url, letter){
        url = ensureFlagsParam(url);
        const m = url.match(/flags=([^&]*)/); let flags = m? m[1] : '';
        if(!flags.includes(letter)) {
            flags += letter;
        }
        return url.replace(/flags=[^&]*/, 'flags=' + flags);
    }
    function removeFlag(chartUrl, letter) {
        let match = chartUrl.match(/flags=([^&]*)/);
        let flags = match ? match[1] : "";
        flags = flags.replace(new RegExp(letter, "g"), "");
        return chartUrl.replace(/flags=[^&]*/, "flags=" + flags);
    }

    function setChartUrlFlag(flag, value) {
        fchart.setChartUrlFlag(flag, value);
        if (value == 'true') {
            chartPdfUrl = addFlag(chartPdfUrl, flag);
            chartUrlEq = addFlag(chartUrlEq, flag);
            chartUrlHoriz = addFlag(chartUrlHoriz, flag);
        } else {
            chartPdfUrl = removeFlag(chartPdfUrl, flag);
            chartUrlEq = removeFlag(chartUrlEq, flag);
            chartUrlHoriz = removeFlag(chartUrlHoriz, flag);
        }
    }

    function getFullscreenSplitViewUrlPart(prefix) {
        let res = "";
        if ($('#fullscreen').val() == 'true') {
            res += "&fullscreen=" + $('#fullscreen').val();
        }
        if ($('#splitview').val() == 'true') {
            res += "&splitview=" + $('#splitview').val();
        }
        if (res !== "") {
            res = prefix + res.substring(1);
        }
        return res;
    }

    function updateChartUrls() {
        if (isEquatorial) {
            fchart.updateUrls(isEquatorial, legendUrlEq, chartUrlEq, sceneUrlEq);
        } else {
            fchart.updateUrls(isEquatorial, legendUrlHoriz, chartUrlHoriz, sceneUrlHoriz);
        }
    }

    function setEyepieceFov(eyepieceFov) {
        $('#eyepiece_fov').val(eyepieceFov);
        fchart.setLegendUrlParam('epfov', eyepieceFov);
        fchart.reloadLegendImage();
    }

    function unselectFov() {
        $('#eyepiece_fov').val('');
        $('#show_telrad').val('false');
        $('#btelrad').removeClass('active');
        chart_param_ajax('chart_eyepiece_fov', '', 'chart_show_telrad', 'false');
        setChartUrlFlag('T', 'false');
        fchart.setLegendUrlParam('epfov', '');
        fchart.reloadLegendImage();
    }

    function removeParamFromRelativeUrl(relativeUrl, param) {
        const baseUrl = window.location.origin;
        const url = new URL(relativeUrl, baseUrl);
        url.searchParams.delete(param);
        return url.toString();
    }

    function syncDateTimeInput() {
        const year   = parseInt($('#yearInput').val(), 10)   || 0;
        const month  = parseInt($('#monthInput').val(), 10)  || 1;
        const day    = parseInt($('#dayInput').val(), 10)    || 1;
        const hour   = parseInt($('#hourInput').val(), 10)   || 0;
        const minute = parseInt($('#minuteInput').val(), 10) || 0;
        const second = parseInt($('#secondInput').val(), 10) || 0;

        const d = new Date(year, month - 1, day, hour, minute, second);
        const dateISO = d.toISOString();
        $('#chart_date_time').val(dateISO);
        if (fchart) {
            fchart.setDateTimeISO(dateISO);
            fchart.reloadImage();
        }
    }

    function syncDateTimeComponentsInputs(syncCalChartDateTime) {
        const isoValue = $('#chart_date_time').val();
        if (isoValue) {
            const date = new Date(isoValue);
            if (!isNaN(date.getTime())) {
                $('#yearInput').val(date.getFullYear());
                $('#monthInput').val(date.getMonth() + 1);
                $('#dayInput').val(date.getDate());
                $('#hourInput').val(date.getHours());
                $('#minuteInput').val(date.getMinutes());
                $('#secondInput').val(date.getSeconds());
                if (syncCalChartDateTime) {
                    $('#cal_chart_date_time').calendar('set date', date);
                }
            }
        }
    }

    function updateDateTimeControls(useCurrentTime) {
        $("#use_current_time").val(useCurrentTime ? "true" : "false");

        var dateTimeInputs = [
            "#yearInput",
            "#monthInput",
            "#dayInput",
            "#hourInput",
            "#minuteInput",
            "#secondInput"
        ];

        $(dateTimeInputs.join(", ")).prop("disabled", useCurrentTime);

        var dateTimeButtons = [
            ".increment-year", ".decrement-year", ".increment-month", ".decrement-month",
            ".increment-day", ".decrement-day", ".increment-hour", ".decrement-hour",
            ".increment-minute", ".decrement-minute", ".increment-second", ".decrement-second"
        ];

        $(dateTimeButtons.join(", ")).toggleClass("disabled", useCurrentTime);

        $('#cal_chart_date_time').toggleClass("disabled", useCurrentTime);

        if (fchart) {
            fchart.setUseCurrentTime(useCurrentTime);
            fchart.reloadImage();
        }
    }

    function changeDateTimeValue(component, delta) {
        let year   = parseInt($('#yearInput').val(), 10)   || 0;
        let month  = parseInt($('#monthInput').val(), 10)  || 0;
        let day    = parseInt($('#dayInput').val(), 10)    || 1;
        let hour   = parseInt($('#hourInput').val(), 10)   || 0;
        let minute = parseInt($('#minuteInput').val(), 10) || 0;
        let second = parseInt($('#secondInput').val(), 10) || 0;

        let date = new Date(year, month - 1, day, hour, minute, second);

        switch(component) {
            case 'year':
                date.setFullYear(date.getFullYear() + delta);
                break;
            case 'month':
                date.setMonth(date.getMonth() + delta);
                break;
            case 'day':
                date.setDate(date.getDate() + delta);
                break;
            case 'hour':
                date.setHours(date.getHours() + delta);
                break;
            case 'minute':
                date.setMinutes(date.getMinutes() + delta);
                break;
            case 'second':
                date.setSeconds(date.getSeconds() + delta);
                break;
        }

        $('#yearInput').val(date.getFullYear());
        $('#monthInput').val(date.getMonth() + 1);
        $('#dayInput').val(date.getDate());
        $('#hourInput').val(date.getHours());
        $('#minuteInput').val(date.getMinutes());
        $('#secondInput').val(date.getSeconds());

        syncDateTimeInput();
        $('#cal_chart_date_time').calendar('set date', date);
    }

    $('#cb_use_current_time').change(function() {
        updateDateTimeControls(this.checked);
    });

    $('#cb_use_auto_location').change(function() {
        var value = this.checked ? 'true' : 'false';
        if (this.checked) {
            $('.dlocation').addClass('disabled');
        } else {
            $('.dlocation').removeClass('disabled');
        }
        let response = chart_param_ajax('use_auto_location', value);
        if (response != null) {
            $('#location_city_name').text(response.data.location_city_name);
            $('#longitude').val(response.data.longitude);
            $('#latitude').val(response.data.latitude);
            fchart.setLongitude(response.data.longitude);
            fchart.setLatitude(response.data.latitude);
        }
        fchart.reloadImage();
    });

    $('.increment-year').on('click', function(){ changeDateTimeValue('year', +1); });
    $('.increment-month').on('click', function(){ changeDateTimeValue('month', +1); });
    $('.increment-day').on('click', function(){ changeDateTimeValue('day', +1); });
    $('.increment-hour').on('click', function(){ changeDateTimeValue('hour', +1); });
    $('.increment-minute').on('click', function(){ changeDateTimeValue('minute', +1); });
    $('.increment-second').on('click', function(){ changeDateTimeValue('second', +1); });

    $('.decrement-year').on('click', function(){ changeDateTimeValue('year', -1); });
    $('.decrement-month').on('click', function(){ changeDateTimeValue('month', -1); });
    $('.decrement-day').on('click', function(){ changeDateTimeValue('day', -1); });
    $('.decrement-hour').on('click', function(){ changeDateTimeValue('hour', -1); });
    $('.decrement-minute').on('click', function(){ changeDateTimeValue('minute', -1); });
    $('.decrement-second').on('click', function(){ changeDateTimeValue('second', -1); });

    if ({{ 'true' if fchart_form.splitview.data == 'true' else 'false' }}) {
        if (window.innerWidth <= 768) {
            $("#top-menu, #right-menu, #isearch2").hide();
        }
    }

    function chart_param_ajax(...params) {
        const data = {};
        for (let i = 0; i < params.length; i += 2) {
            data[params[i]] = params[i + 1];
        }

        let response = null;

        $.ajax({
            url: "{{ url_for('main_chart.chart_param') }}",
            type: 'POST',
            async: false,
            contentType: 'application/json',
            data: JSON.stringify(data),
            dataType: 'json',
            success: function(res) {
                response = res;
            },
            error: function() {
                console.log('An error occurred while setting session params.');
            }
        });
        return response;
    }

    const THEME_URLS = {
        dark:  "{{ url_for('main.theme_dark') }}",
        light: "{{ url_for('main.theme_light') }}",
        night: "{{ url_for('main.theme_night') }}"
    };

    function applyThemeUrl(url) {
        $.ajax({
            url: url,
            method: "GET",
            cache: false
        }).always(function () {
            const $form = $("#fmchart");
            if ($form.length) {
                $form[0].submit();
            } else {
                window.location.reload();
            }
        });
    }

    function setTheme(themeName) {
        applyThemeUrl(THEME_URLS[themeName]);
    }

    function openFchartHelpModal() {
        const modalContext = (fchart && fchart.isInRealFullScreen && fchart.isInRealFullScreen())
            ? '#' + fullScreenWrapperId
            : 'body';
        $('.ui.modal.fchartHelpModal')
            .modal({
                context: modalContext,
                detachable: false
            })
            .modal('show');
    }

    function setCustomTheme(themeId) {
        var customThemeUrl = "{{ url_for('main.theme_custom', chart_theme_id=123) }}";
        customThemeUrl = customThemeUrl.replace('123', themeId)
        applyThemeUrl(customThemeUrl);
    }

    window.onload = function() {
        if (fchart) {
            fchart.onWindowLoad();
        }
        {% if chart_control.show_not_found %}
        $('.ui.modal.notFoundModal').modal('show');
        {% endif %}

        $('#layers_dropdown').dropdown({ displayType : 'block' });
        syncPerfMeterButton();
        applyPerfMeterStateToChart(fchart);

        updateDateTimeControls({{ 'true' if fchart_form.use_current_time.data=='true' else 'false' }});
        syncDateTimeComponentsInputs(true);

        $('.ui.dropdown.dlocation').dropdown({
            allowAdditions: true,
            minCharacters : 3,
            apiSettings: {
                url: "{{ url_for('main_location.location_autocomplete_unified') }}?q={query}",
                cache: false
            },
            onChange: function (value, text, $selectedItem) {
                if (value) {
                    const [longitude, latitude, cityName] = value.split(',');
                    chart_param_ajax(
                        'user_location_city_name', cityName,
                        'user_location_longitude', longitude,
                        'user_location_latitude', latitude
                    );
                    $('#cb_use_auto_location').checkbox('set unchecked');
                    $('#location_city_name').text(cityName);
                    $('#longitude').val(longitude);
                    $('#latitude').val(latitude);
                    fchart.setLongitude(longitude);
                    fchart.setLatitude(latitude);
                    fchart.reloadImage();
                }
            }
        });
    }

    $('.chart-popup').popup({ on: 'click' });

    $(document).on('keydown.fchartHelp', function(event) {
        const isF1 = event.key === 'F1' || event.which === 112 || event.keyCode === 112;
        if (!isF1 || event.repeat) {
            return;
        }
        const $target = $(event.target);
        if ($target.is('input, textarea, select') || $target.is('[contenteditable=true]') || $target.prop('isContentEditable')) {
            return;
        }
        event.preventDefault();
        openFchartHelpModal();
    });
</script>

{% endmacro %}
