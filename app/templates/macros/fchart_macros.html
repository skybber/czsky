{% macro fchart(fchart_url, fchart_img_url, fchart_legend_url, fchart_pdf_url, fchart_form, chart_dso_list_menu, default_chart_iframe_url='', embed='') %}

{% set is_fullscreen = True if fchart_form.fullscreen.data == 'true' else False %}
{% set is_splitview = True if fchart_form.splitview.data.data == 'true' else False %}
{% set data_position='data-position="left center"' if is_fullscreen or is_splitview else '' %}

<div id="fchart-div" style="width:100%;height:75vh;background:{{ '#fff' if chart_control.theme=='light' else ('#020202' if chart_control.theme=='night' else '#03030D') }}">

  <div  class="ui secondary menu">
  <form id="fmchart" action="{{ fchart_url }}" method="post" class="right menu">
      <input type="hidden" id="ra" name="ra" value="{{ fchart_form.ra.data }}" >
      <input type="hidden" id="dec" name="dec" value="{{ fchart_form.dec.data }}" >
      <input type="hidden" id="fullscreen" name="fullscreen" value="{{ fchart_form.fullscreen.data }}" >
      <input type="hidden" id="splitview" name="splitview" value="{{ fchart_form.splitview.data }}" >
      <input type="hidden" id="radius" name="{{ fchart_form.radius.name }}" value="{{ fchart_form.radius.data }}">
      <input type="hidden" id="show_telrad" name="{{ fchart_form.show_telrad.name }}" value="{{ fchart_form.show_telrad.data }}">
      <input type="hidden" id="show_constell_shapes" name="{{ fchart_form.show_constell_shapes.name }}" value="{{ fchart_form.show_constell_shapes.data }}">
      <input type="hidden" id="show_constell_borders" name="{{ fchart_form.show_constell_borders.name }}" value="{{ fchart_form.show_constell_borders.data }}">
      <input type="hidden" id="show_dso" name="{{ fchart_form.show_dso.name }}" value="{{ fchart_form.show_dso.data }}">
      <input type="hidden" id="show_egrid" name="{{ fchart_form.show_equatorial_grid.name }}" value="{{ fchart_form.show_equatorial_grid.data }}">

      {% if chart_control.has_date_from_to %}
          <div class="ui right horizontally fitted item" style="z-index:100;">
              <div class="ui calendar mobile hidden" id="date_from" data-inverted=""  data-tooltip="{{ _('Date From')}}" data-position="left center" data-variation="tiny basic">
                  <div class="ui input left icon">
                      <i class="calendar icon"></i>
                      <input name="{{ fchart_form.date_from.name }}" placeholder="Date" type="text" style="width:140px"
                              value="{{ fchart_form.date_from.data.strftime('%d/%m/%Y') if fchart_form.date_from.data else ''}}">
                  </div>
              </div>
              <div class="ui calendar mobile hidden" id="date_to" data-inverted=""  data-tooltip="{{ _('Date To')}}" data-position="left center" data-variation="tiny basic">
                  <div class="ui input left icon">
                      <i class="calendar icon"></i>
                      <input name="{{ fchart_form.date_to.name }}" placeholder="Date" type="text" style="width:140px"
                              value="{{ fchart_form.date_to.data.strftime('%d/%m/%Y') if fchart_form.date_to.data else ''}}">
                  </div>
              </div>
          </div>
      {% endif %}

      <div class="ui right horizontally fitted item" style="z-index:100">
          <div class="ui buttons">
              <button id="bshow-telrad" class="ui toggle icon button{{ ' active' if fchart_form.show_telrad.data=='true' else ''}}"
                      data-inverted=""  data-tooltip="{{ _('Telrad')}}" data-position="bottom center" data-variation="tiny basic">
                  <i class="bullseye icon"></i>
              </button>
              <button id="bshow-constell-shapes" class="ui toggle icon button{{ ' active' if fchart_form.show_constell_shapes.data=='true' else ''}}"
                    data-inverted="" data-tooltip="{{ _('Constellation lines')}}" data-position="bottom center" data-variation="tiny basic">
                  <i class="lastfm icon"></i>
              </button>
              <button id="bshow-constell-borders" class="ui toggle icon button{{ ' active' if fchart_form.show_constell_borders.data=='true' else ''}}"
                    data-inverted="" data-tooltip="{{ _('Constellation borders')}}" data-position="bottom center" data-variation="tiny basic">
                  <i class="draw polygon icon"></i>
              </button>
              <button id="bshow-egrid" class="ui toggle icon button{{ ' active' if fchart_form.show_equatorial_grid.data=='true' else ''}}"
                    data-inverted="" data-tooltip="{{ _('Equatorial grid')}}" data-position="bottom center" data-variation="tiny basic">
                  <i class="globe icon"></i>
              </button>
              <button id="bshow-dso" class="ui toggle icon button{{ ' active' if fchart_form.show_dso.data=='true' else ''}}"
                    data-inverted="" data-tooltip="{{ _('Deepsky objects')}}" data-position="bottom center" data-variation="tiny basic">
                  <i class="superpowers icon"></i>
              </button>
          </div>
      </div>
      <!-- Star mag limit -->
      <div class="ui horizontally fitted item" style="z-index:100">
          <div class="ui buttons">
              <button id="decmag" class="ui icon {{ chart_control.disable_dec_mag }} button mobile hidden">
                  <i class="left chevron icon"></i>
              </button>
              <div class="ui icon dropdown button" data-inverted="" data-tooltip="{{ _('Limit mag') }}" data-position="left center" data-variation="tiny basic">
                  <input type="hidden" id="maglim" name="maglim" value="{{ fchart_form.maglim.data }}" >
                  <span id="smaglim" class="text">{{ fchart_form.maglim.data }}</span>
                  <div id="maglim_menu" class="menu">
                      {% for mag_item in range(chart_control.mag_scale[0], chart_control.mag_scale[1] + 1) %}
                          <div class="item">{{ mag_item }}</div>
                      {% endfor %}
                  </div>
              </div>
              <button id="incmag" class="ui right icon {{ chart_control.disable_inc_mag }} button mobile hidden">
                  <i class="right chevron icon"></i>
              </button>
          </div>
      </div>
      <!-- dso mag limit -->
      <div class="ui horizontally fitted item" style="z-index:100">
          <div class="ui buttons">
              <button id="decdsomag" class="ui icon {{ chart_control.disable_dso_dec_mag }} button mobile hidden">
                  <i class="left chevron icon"></i>
              </button>
              <div class="ui icon dropdown button"  data-inverted="" data-tooltip="{{ _('DSO limit mag') }}" data-position="left center" data-variation="tiny basic">
                  <input type="hidden" id="dso_maglim" name="dso_maglim" value="{{ fchart_form.dso_maglim.data }}">
                  <span id="sdso_maglim" class="text">{{ fchart_form.dso_maglim.data }}</span>
                  <div id="dso_maglim_menu" class="menu">
                      {% for mag_item in range(chart_control.dso_mag_scale[0], chart_control.dso_mag_scale[1] + 1) %}
                          <div class="item">
                              {{ mag_item }}
                          </div>
                      {% endfor %}
                  </div>
              </div>
              <button id="incdsomag" class="ui right icon {{ chart_control.disable_dso_inc_mag }} button mobile hidden">
                  <i class="right chevron icon"></i>
              </button>
          </div>
      </div>
      <div class="ui horizontally fitted item mobile hidden" style="z-index:100">
          <div class="ui floating dropdown icon button" data-inverted="" data-tooltip="{{ _('Object List') }}" data-position="left center" data-variation="tiny basic">
              <i class="list icon"></i>
              <div class="menu">
                  <div class="item" onclick="callDsoListUrl('{{ chart_control.cancel_selection_url }}')">{{ _('None') }}</div>
                  {% set dso_list_menu=chart_control.chart_dso_list_menu %}
                  {% if dso_list_menu and (dso_list_menu.is_wish_list or dso_list_menu.session_plans or dso_list_menu.observations) %}
                      {% if dso_list_menu.is_wish_list %}
                          <div class="item" onclick="callDsoListUrl('{{ url_for('main_wishlist.wish_list_chart') }}')">{{ _('Wish List') }}</div>
                      {% endif %}
                      {% if dso_list_menu.session_plans %}
                          <div class="item">
                              <i class="dropdown icon"></i>
                              <span class="text">{{ _('Session plans')}}</span>
                              <div class="right menu">
                                  {% for spl in dso_list_menu.session_plans %}
                                      <div class="item" onclick="callDsoListUrl('{{ url_for('main_sessionplan.session_plan_chart', session_plan_id=spl.id) }}')">
                                        {{ spl.for_date.strftime('%Y-%m-%d') }} {{ spl.location.name if spl.location else spl.txt_location_name }}
                                      </div>
                                  {% endfor %}
                              </div>
                          </div>
                      {% endif %}
                      {% if dso_list_menu.observations %}
                          <div class="item">
                              <i class="dropdown icon"></i>
                              <span class="text">{{ _('Observations')}}</span>
                              <div class="right menu">
                                  {% for obs in dso_list_menu.observations %}
                                      <div class="item" onclick="callDsoListUrl('{{ url_for('main_observation.observation_chart', observation_id=obs.id) }}')">
                                        {{ obs.date.strftime('%Y-%m-%d') }} {{ obs.location.name if obs.location else obs.txt_location_name }}
                                      </div>
                                  {% endfor %}
                              </div>
                          </div>
                      {% endif %}
                      {% if dso_list_menu.dso_lists %}
                          <div class="item">
                              <i class="dropdown icon"></i>
                              <span class="text">{{ _('DSO List')}}</span>
                              <div class="right menu">
                                  {% for dsol in dso_list_menu.dso_lists %}
                                      <div class="item" onclick="callDsoListUrl('{{ url_for('main_dso_list.dso_list_chart', dso_list_id=dsol.id) }}')">{{ dsol.long_name }}</div>
                                  {% endfor %}
                              </div>
                          </div>
                      {% endif %}
                  {% elif dso_list_menu and chart_control.chart_dso_list_menu.dso_lists %}
                      {% for dsol in dso_list_menu.dso_lists %}
                          <div class="item" onclick="callDsoListUrl('{{ url_for('main_dso_list.dso_list_chart', dso_list_id=dsol.id) }}')">{{ dsol.long_name }}</div>
                      {% endfor %}
                  {% endif %}
              </div>
          </div>
      </div>

      <input type="hidden" name="csrf_token" value="{{ csrf_token()|safe }}">
  </form>
  <!-- Export to PDF -->
  {% if fchart_pdf_url is not none %}
      <div class="ui horizontally fitted tablet item mobile hidden" style="z-index:100">
          <div class="ui buttons">
                  <a id="download_pdf" href="" target="_blank" class="ui icon button" data-inverted="" data-tooltip="{{ _('PDF export') }}" data-position="bottom center" data-variation="tiny basic">
                      <i class="download icon"></i>
                  </a>
          </div>
      </div>
  {% endif %}
  <div id="isearch" class="ui horizontally fitted item computer tablet only" style="width: 150px; z-index:100; display:none;">
      <div class="ui icon input">
          <input id="search" name="search" class="search" type="text" placeholder="{{ _('Search...') }} ">
          <i class="search icon"></i>
      </div>
  </div>
  <div class="ui horizontally fitted item computer tablet only" style="margin-right:0px; z-index:100">
      <div class="ui buttons">
          <button id="bsplitview" type="button" class="ui icon button" data-inverted="" data-tooltip="{{ _('Split view') }}" data-position="bottom center" data-variation="tiny basic">
              <i class="columns icon"></i>
          </button>
      </div>
  </div>
  <div class="ui horizontally fitted item" style="margin-right:16px; z-index:100">
      <div class="ui buttons">
          <button id="bfullscreen" type="button" class="ui icon button">
              <i class="expand icon"></i>
          </button>
      </div>
  </div>
  </div>

</div>

{% if chart_control.show_not_found %}
    <div class="ui tiny modal notFoundModal" style="z-index:10000;">
        <div class="header">{{ _('Object not found') }}</div>
        <div class="content">
            <p>{{ _('Specified object was not found.') }}</p>
        </div>
        <div class="actions">
            <a class="ui right labeled icon approve button" href="#" onclick="$('.ui.modal.notFoundModal').modal('hide')">
               {{ _('Close') }}
               <i class="checkmark icon"></i>
          </a>
        </div>
    </div>
<style>
.modals.page {
  z-index: 10000 !important;
}
</style>
{% endif %}

<script type="text/javascript" src="{{ url_for('static', filename='js/fchart.js') }}"></script>

<script type="text/javascript">
    var submitDisabled = false;
    var labels = ["1", "2", "5", "10", "20", "40", "80"];

    var fieldSizes = [{{ chart_control.gui_field_sizes }}];

    var magRanges = [
        {% for mr in chart_control.mag_ranges %} [{{ mr[0] ~ ',' ~ mr[1] }}], {% endfor %}
    ];

    var magRangeValues = [
        {% for mrv in chart_control.mag_range_values %}{{ mrv }}, {% endfor %}
    ];

    var dsoMagRanges = [
        {% for mr in chart_control.dso_mag_ranges %} [{{ mr[0] ~ ',' ~ mr[1] }}], {% endfor %}
    ];
    var dsoMagRangeValues = [
        {% for mrv in chart_control.dso_mag_range_values %}{{ mrv }}, {% endfor %}
    ];

    var ra = parseFloat($('#ra').val());
    var dec = parseFloat($('#dec').val());

    var theme = '{{ chart_control.theme }}';

    var chartUrl = "{{ fchart_img_url | safe }}";
    var legendUrl = "{{ fchart_legend_url | safe }}";

    var fchart = new FChart('#fchart-div', {{ chart_control.gui_field_index }}, fieldSizes, ra, dec, theme, legendUrl, chartUrl,
            "{{ url_for('main.global_search') }}?q=", true,
            {{ 'true' if fchart_form.fullscreen.data == 'true' else 'false' }},
            {{ 'true' if fchart_form.splitview.data == 'true' else 'false' }},
            '{{ default_chart_iframe_url }}',
            '{{ embed }}'
    );

    if ({{ 'true' if fchart_form.fullscreen.data == 'true' or fchart_form.splitview.data == 'true' else 'false' }}) {
        $("#isearch").show();
    }

    fchart.onFieldChange(function(fldSizeIndex) {
        submitDisabled = true;
        var index = Math.ceil((fldSizeIndex+1) / 2);
        $('#radius').val(index);
        $('#maglim').val(magRangeValues[index-1]);
        $('#dso_maglim').val(dsoMagRangeValues[index-1]);
        $('#smaglim').text(magRangeValues[index-1].toString());
        $('#sdso_maglim').text(dsoMagRangeValues[index-1].toString());

        $('#maglim_menu').empty();
        var i;
        for (i=magRanges[index-1][0]; i<=magRanges[index-1][1]; i++) {
            $('<div class="item">' + i +'</div>')
                .appendTo('#maglim_menu');
        }

        $('#dso_maglim_menu').empty();
        for (i=dsoMagRanges[index-1][0]; i<=dsoMagRanges[index-1][1]; i++) {
            $('<div class="item">' + i +'</div>')
                .appendTo('#dso_maglim_menu');
        }

        submitDisabled = false;
    });

    fchart.onFullscreenChange(function(fullScreen) {
        $('#fullscreen').val(fullScreen);
        if (fullScreen) {
            $("#isearch").show();
        } else {
            $("#isearch").hide();
        }
    });

    fchart.onSplitViewChange(function(splitViewVisible) {
        $('#splitview').val(splitViewVisible);
        if (splitViewVisible) {
            $("#isearch").show();
        } else {
            $("#isearch").hide();
        }
    });

    $('#bshow-telrad').click(function(){
        $(this).toggleClass('active');
        $('#show_telrad').val($('#show_telrad').val() == 'true' ? 'false' : 'true');
    });

    $('#bshow-constell-shapes').click(function(){
        $(this).toggleClass('active');
        $('#show_constell_shapes').val($('#show_constell_shapes').val() == 'true' ? 'false' : 'true');
    });

    $('#bshow-constell-borders').click(function(){
        $(this).toggleClass('active');
        $('#show_constell_borders').val($('#show_constell_borders').val() == 'true' ? 'false' : 'true');
    });

    $('#bshow-dso').click(function(){
        $(this).toggleClass('active');
        $('#show_dso').val($('#show_dso').val() == 'true' ? 'false' : 'true');
    });

    $('#bshow-egrid').click(function(){
        $(this).toggleClass('active');
        $('#show_egrid').val($('#show_egrid').val() == 'true' ? 'false' : 'true');
    });

    $('#bfullscreen').click(function(){
        fchart.toggleFullscreen();
    });

    $('#bsplitview').click(function(){
        fchart.toggleSplitView();
    });

    $('.ui.dropdown').dropdown();

    $( '#decmag' ).click(function() {
        prev = +$('#maglim').val();
        $('#maglim').val(prev - 1);
        $('#fmchart').submit();
    });

    $( '#incmag' ).click(function() {
        prev = +$('#maglim').val();
        $('#maglim').val(prev + 1);
        $('#fmchart').submit();
    });

    $( '#decdsomag' ).click(function() {
        prev = +$('#dso_maglim').val();
        $('#dso_maglim').val(prev - 1);
        $('#fmchart').submit();
    });

    $( '#incdsomag' ).click(function() {
        prev = +$('#dso_maglim').val();
        $('#dso_maglim').val(prev + 1);
        $('#fmchart').submit();
    });

    $('#maglim').change(function() {
        if (!submitDisabled)
            this.form.submit();
    });

    $('#dso_maglim').change(function() {
        if (!submitDisabled)
            this.form.submit();
    });

    $('#download_pdf').click(function(event){
        $('#download_pdf').attr("href", fchart.formatUrl('{{ fchart_pdf_url | safe  }}'));
    });

    $('.search').keypress(function(event) {
        var keycode = (event.keyCode ? event.keyCode : event.which);
        if(keycode == '13'){
            window.location.href = encodeURI("{{ url_for('main.global_search') }}?q=" + $(this).val() + "&fromchart=true&seltab=chart" + getFullscreenSplitViewUrlPart("&") +
                    "&back_url=" + encodeURIComponent('{{ chart_control.back_search_url_b64 }}'));
        }
        event.stopPropagation();
    });

    $('#date_from').calendar({
        type: 'date',
        monthFirst: false,
        endCalendar: $('#date_to'),
        formatter: {
            date: function (date, settings) {
            if (!date) return '';
            var day = date.getDate();
            var month = date.getMonth() + 1;
            var year = date.getFullYear();
            return day + '/' + month + '/' + year;
            }
        },
    });

    $('#date_to').calendar({
        type: 'date',
        monthFirst: false,
        startCalendar: $('#date_from'),
        formatter: {
            date: function (date, settings) {
            if (!date) return '';
            var day = date.getDate();
            var month = date.getMonth() + 1;
            var year = date.getFullYear();
            return day + '/' + month + '/' + year;
            }
        },
        onChange: function () {
            $(this).closest('form').submit();
        }
    });

    function getFullscreenSplitViewUrlPart(prefix) {
        res = "";
        if ($('#fullscreen').val() == 'true') {
            res += "&fullscreen=" + $('#fullscreen').val();
        }
        if ($('#splitview').val() == 'true') {
            res += "&splitview=" + $('#splitview').val();
        }
        if (res != "") {
            res = prefix + res.substring(1);
        }
        return res

    }

    function callDsoListUrl(url) {
        window.location.href = encodeURI(url + getFullscreenSplitViewUrlPart("?"));
        event.stopPropagation();
    }

    function updateChartUrls(legendUrl, chartUrl) {
        fchart.updateUrls(legendUrl, chartUrl);
    }

    window.onload = function() {
        fchart.onWindowLoad();
{% if chart_control.show_not_found %}
        $('.ui.modal.notFoundModal')
            .modal('show');
{% endif %}
    }

</script>
<style>
.ui.active.toggle.button {
  background-color: #006000 !important;
}
</style>


{% endmacro %}
