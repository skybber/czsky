{% import 'macros/form_macros.html' as f %}
{% import 'macros/common_macros.html' as commons %}

{% set flashes = {
    'error':   get_flashed_messages(category_filter=['form-error']),
    'info':    get_flashed_messages(category_filter=['form-info']),
    'success': get_flashed_messages(category_filter=['form-success'])
} %}


{{ f.begin_form(search_form, flashes, action=url_for('main_sessionplan.session_plan_schedule', session_plan_id=session_plan.id), extra_classes='ui tiny menu') }}

    <div class="ui item">
        <div id="objsource_dropdown" class="ui dropdown" data-inverted="" data-tooltip="{{ _('Object Source') }}" data-variation="tiny basic">
            <input type="hidden" id="obj_source" name="{{ search_form.obj_source.name }}" value="{{ search_form.obj_source.data }}">
            <span class="text">{{ _('Choose Source') }}</span>
            <i class="dropdown icon"></i>
            <div class="menu">
                <div class="item" data-value="WL">{{ _('Wish List') }}</div>
                <div class="item">
                    <i class="dropdown icon"></i>
                    <span class="text">{{ _('DSO List')}}</span>
                    <div class="menu">
                        {% for dsol in dso_lists %}
                            <div class="item" data-value="DL_{{ dsol.id }}">{{ dsol.name }}</div>
                        {% endfor %}
                    </div>
                </div>
                <div class="item">
                    <i class="dropdown icon"></i>
                    <span class="text">{{ _('Catalogs')}}</span>
                    <div class="menu">
                        {% for cat in catalogues_menu_items %}
                            <div class="item" data-value="{{ cat[0] }}">{{ cat[1] }}</div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="ui item computer tablet only" class="ui dropdown" data-inverted="" data-tooltip="{{ _('Object Type') }}" data-variation="tiny basic">
        {{ search_form.dso_type(class='ui dropdown button',onchange='this.form.submit()') }}
    </div>
    <div class="ui item" class="ui dropdown" data-inverted="" data-tooltip="{{ _('Limit mag') }}" data-variation="tiny basic">
        <div class="ui icon dropdown button">
            <input type="hidden" id="{{ search_form.maglim.name }}" name="{{ search_form.maglim.name }}" value="{{ search_form.maglim.data }}"
                    onchange="this.form.submit()">
            <span class="text">{{ search_form.maglim.data }}</span>
            <div class="menu">
                <div class="item"></div>
                {% for mag_item in range(mag_scale[0], mag_scale[1] + 1) %}
                    <div class="item">{{ mag_item }}</div>
                {% endfor %}
            </div>
        </div>
    </div>
    <div id="time_from" class="ui calendar item" style="width: 120px" class="ui dropdown" data-inverted="" data-tooltip="{{ _('Time from') }}" data-variation="tiny basic">
      <div class="ui input left icon">
        <i class="time icon"></i>
        <input type="text" placeholder="Time" id="{{ search_form.time_from.name }}" name="{{ search_form.time_from.name }}" value="{{ search_form.time_from.data }}">
      </div>
    </div>
    <div id="time_to" class="ui calendar item" style="width: 120px" class="ui dropdown" data-inverted="" data-tooltip="{{ _('Time to') }}" data-variation="tiny basic">
      <div class="ui input left icon">
        <i class="time icon"></i>
        <input type="text" placeholder="Time" id="{{ search_form.time_to.name }}" name="{{ search_form.time_to.name }}" value="{{ search_form.time_to.data }}">
      </div>
    </div>
{{ f.end_form(search_form) }}


<div class="ui segment" style="overflow-x: scroll;">
<div class="ui two column very relaxed grid">
    <div class="column">
      <table class="ui searchable sortable unstackable selectable celled table">
          <thead>
              <tr>
                  <th>
                      <a href="{{ url_for('main_sessionplan.session_plan_schedule', session_plan_id=session_plan.id, page=pagination.page, sortby=table_sort['name'].sort) }}" style="color: inherit;">
                          {{ _('Name') }} {{ table_sort['name'].icon | safe }}
                      </a>
                  </th>

                  <th>{{ _('Type') }}</th>
                  <th class="right aligned collapsing">
                      <a href="{{ url_for('main_sessionplan.session_plan_schedule', session_plan_id=session_plan.id, page=pagination.page, sortby=table_sort['constellation'].sort) }}" style="color: inherit;">
                          {{ _('Constellation') }} {{ table_sort['constellation'].icon | safe }}
                      </a>
                  </th>
                  <th>
                      <a href="{{ url_for('main_sessionplan.session_plan_schedule', session_plan_id=session_plan.id, page=pagination.page, sortby=table_sort['mag'].sort) }}" style="color: inherit;white-space: nowrap;">
                          mag {{ table_sort['mag'].icon | safe }}
                      </a>
                  </th>
                  <th>{{ _('Rise') }}</th>
                  <th>{{ _('Merid') }}</th>
                  <th>{{ _('Set') }}</th>
                  <th></th>
              </tr>
          </thead>
          <tbody>
          {% macro to_dso_url1(item) %}{{ url_for('main_deepskyobject.deepskyobject_info', dso_id=item[0].name, back='session_plan', back_id=session_plan.id) }}{% endmacro %}

          {% for item in selection_compound_list %}
              <tr>
                  <td onclick="window.location.href='{{ to_dso_url1(item) }}';">{{ item[0].denormalized_name() }}</td>
                  <td onclick="window.location.href='{{ to_dso_url1(item) }}';">{{ item[0].type }}</td>
                  <td onclick="window.location.href='{{ to_dso_url1(item) }}';">{{ item[0].get_constellation_iau_code() }}</td>
                  <td onclick="window.location.href='{{ to_dso_url1(item) }}';">{{ item[0].mag }}</td>
                  <td onclick="window.location.href='{{ to_dso_url1(item) }}';">{{ item[1] }}</td>
                  <td onclick="window.location.href='{{ to_dso_url1(item) }}';">{{ item[2] }}</td>
                  <td onclick="window.location.href='{{ to_dso_url1(item) }}';">{{ item[3] }}</td>
                  <td class="collapsing specialClass">
                      <a class="ui icon mini button" href="{{ url_for('main_sessionplan.session_plan_item_add', session_plan_id=session_plan.id, dso_id=item[0].id) }}">
                          <i class="arrow right icon"></i>
                      </a>
                  </td>
              </tr>
          {% endfor %}
          </tbody>
      </table>
      {{ pagination.links }} {{ commons.items_per_page(search_form.items_per_page) }} {{ pagination.info }}
    </div>
    <div class="column">

      <div class="ui tiny menu">
          {{ f.begin_form(add_form, flashes, action=url_for('main_sessionplan.session_plan_item_add', session_plan_id=session_plan.id), extra_classes="ui item") }}
          <div class="ui action input">
              <input type="text" name="{{ add_form.dso_name.name }}" placeholder="Add dso...">
              <button class="ui icon button">
                  <i class="plus icon"></i>
              </button>
          </div>
          {{ f.end_form(add_form) }}
          <div class="right tiny menu">
              <div class="ui item">
                  <button id="clear_schedule" class="ui icon negative button" data-tooltip="{{ _('Clear schedule') }}" data-variation="tiny basic">
                      <i class="trash alternate icon"></i>
                  </button>
              </div>
                  <form id="fmupload" method="post" action="{{ url_for('main_sessionplan.session_plan_upload', session_plan_id=session_plan.id) }}" enctype="multipart/form-data" class="ui item">
                      <label for="file" class="ui icon button"  data-tooltip="{{ _('Upload plan') }}" data-variation="tiny basic">
                          <i class="upload icon"></i>
                      </label>
                      <input type="file" id="file" name="file" class="ui file input">
                      <input type="hidden" name="csrf_token" value="{{ csrf_token()|safe }}">
                  </form>
          </div>
      </div>

      <table class="ui searchable sortable unstackable selectable celled table">
          <thead>
              <tr>
                  <th class="sorted ascending">Name</th>
                  <th>{{ _('Type') }}</th>
                  <th>{{ _('Constellation') }}</th>
                  <th>mag</th>
                  <th>{{ _('Rise') }}</th>
                  <th>{{ _('Merid') }}</th>
                  <th>{{ _('Set') }}</th>
                  <th></th>
              </tr>
          </thead>
          <tbody>
          {% macro to_dso_url2(item) %}{{ url_for('main_deepskyobject.deepskyobject_info', dso_id=item[0].deepskyObject.name, back='session_plan', back_id=session_plan.id) }}{% endmacro %}

          {% for item in session_plan_compound_list %}
              <tr>
                  <td onclick="window.location.href='{{ to_dso_url2(item) }}';">{{ item[0].deepskyObject.denormalized_name() }}</td>
                  <td onclick="window.location.href='{{ to_dso_url2(item) }}';">{{ item[0].deepskyObject.type }}</td>
                  <td onclick="window.location.href='{{ to_dso_url2(item) }}';">{{ item[0].deepskyObject.get_constellation_iau_code() }}</td>
                  <td onclick="window.location.href='{{ to_dso_url2(item) }}';">{{ item[0].deepskyObject.mag }}</td>
                  <td onclick="window.location.href='{{ to_dso_url2(item) }}';">{{ item[1] }}</td>
                  <td onclick="window.location.href='{{ to_dso_url2(item) }}';">{{ item[2] }}</td>
                  <td onclick="window.location.href='{{ to_dso_url2(item) }}';">{{ item[3] }}</td>
                   <td class="collapsing specialClass">
                      <a class="ui icon mini button" href="{{ url_for('main_sessionplan.session_plan_item_delete', session_plan_id=session_plan.id, item_id=item[0].id) }}">
                          <i class="trash alternate icon"></i>
                      </a>
                  </td>
              </tr>
          {% endfor %}
          </tbody>
      </table>
    </div>
  </div>
</div>

<div class="ui tiny modal loadModal">
  <div class="header">{{ _('Load schedule list') }}</div>
  <div class="content">
    <p>{{ _('All data from file will be added to schedule list.') }}</p>
    <p>{{ _('Are you sure you want to load schedule list?') }}</p>
  </div>
  <div class="actions">
    <div class="ui negative cancel button">{{ _('No') }}</div>
    <button id="confirm_upload" class="ui positive right labeled icon approve button">
        {{ _('Yes') }}
        <i class="checkmark icon"></i>
    </button>
  </div>
</div>

<div class="ui tiny modal deleteModal">
  <div class="header">{{ _('Clear schedule list') }}</div>
  <div class="content">
    <p>{{ _('All planned items will be removed.') }}</p>
    <p>{{ _('Are you sure you want to clear planned list?') }}</p>
  </div>
  <div class="actions">
    <div class="ui negative cancel button">{{ _('No') }}</div>
    <a class="ui positive right labeled icon approve button" href="{{ url_for('main_sessionplan.session_plan_clear', session_plan_id=session_plan.id) }}">
        {{ _('Yes') }}
        <i class="checkmark icon"></i>
    </a>
  </div>
</div>

<style>
    .ui.file.input {
      display: none;
    }
</style>

<script type="text/javascript">
    $(function(){
        $('.ui.modal.loadModal').modal({
            onApprove: function() {
                return validateModal()
            }
        });
        $('.ui.modal.deleteModal').modal({
            onApprove: function() {
                return validateModal()
            }
        });
        $("tr td.specialClass").click(function (e) {
            e.cancelBubble();
            e.stopPropagation();
        });
        $('#file').change(function() {
            $('.ui.modal.loadModal')
                .modal('show');
        });
        $("#confirm_upload").click(function() {
            $("#fmupload" ).submit();
        });
        $('#clear_schedule').click(function() {
            $('.ui.modal.deleteModal')
                .modal('show');
        });
        $('#objsource_dropdown')
            .dropdown({
              allowCategorySelection: true,
              onChange: function (value, text, $selectedItem) {
                  $('#obj_source').val(value);
                  $(this).closest('form').submit();
              }
        });
        $('#time_from').calendar({
            type: 'time',
            ampm: false,
            onChange: function(value) {
                $(this).calendar.changed = true;
            },
            onHide: function () {
                if ($(this).calendar.changed) {
                    $(this).calendar.changed = false;
                    $(this).closest('form').submit();
                }
            }
        })
        $('#time_to').calendar({
            type: 'time',
            ampm: false,
            changed: false,
            onChange: function(value) {
                $(this).calendar.changed = true;
            },
            onHide: function () {
                if ($(this).calendar.changed) {
                    $(this).calendar.changed = false;
                    $(this).closest('form').submit();
                }
            }
        })
      ;
    });
</script>
