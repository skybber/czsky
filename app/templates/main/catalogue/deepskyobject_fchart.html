{% import 'macros/common_macros.html' as commons %}

  <form id="fmchart" action="{{ url_for('main_deepskyobject.deepskyobject_fchart', dso_id=dso.name, back=back, back_id=back_id) }}" method="post" class="ui secondary menu">
      <!-- Field radius -->
      <div class="ui labeled item">
          <div class="ui labeled ticked small slider" id="slider-field-size" style="width:200px">
          </div>
          <input type="hidden" id="{{ form.radius.name }}" name="{{ form.radius.name }}" value="{{ form.radius.data }}">
          <div class="top right aligned floating ui label">{{ _('Field Size') }}</div>
      </div>
      <!-- Star mag limit -->
      <div class="ui labeled item">
          <div class="ui buttons">
              <button id="decmag" class="ui icon {{ disable_dec_mag }} button">
                  <i class="left chevron icon"></i>
              </button>
              <div class="ui icon dropdown button">
                  <input type="hidden" id="{{ form.maglim.name }}" name="{{ form.maglim.name }}" value="{{ form.maglim.data }}"
                          onchange="this.form.submit()">
                  <span class="text">{{ form.maglim.data }}</span>
                  <div class="menu">
                      {% for mag_item in range(mag_scale[0], mag_scale[1] + 1) %}
                          <div class="item">{{ mag_item }}</div>
                      {% endfor %}
                  </div>
              </div>
              <button id="incmag" class="ui right icon {{ disable_inc_mag }} button">
                  <i class="right chevron icon"></i>
              </button>
          </div>
          <div class="top right aligned floating ui label">{{ _('Limit mag') }}</div>
      </div>
      <!-- dso mag limit -->
      <div class="ui labeled item">
          <div class="ui buttons">
              <button id="decdsomag" class="ui icon {{ disable_dso_dec_mag }} button">
                  <i class="left chevron icon"></i>
              </button>
              <div class="ui icon dropdown button">
                  <input type="hidden" id="{{ form.dso_maglim.name }}" name="{{ form.dso_maglim.name }}" value="{{ form.dso_maglim.data }}"
                          onchange="this.form.submit()">
                  <span class="text">{{ form.dso_maglim.data }}</span>
                  <div class="menu">
                      {% for mag_item in range(dso_mag_scale[0], dso_mag_scale[1] + 1) %}
                          <div class="item">
                              {{ mag_item }}
                          </div>
                      {% endfor %}
                  </div>
              </div>
              <button id="incdsomag" class="ui right icon {{ disable_dso_inc_mag }} button">
                  <i class="right chevron icon"></i>
              </button>
          </div>
          <div class="top right aligned floating ui label">{{ _('DSO limit mag') }}</div>
      </div>
      {% if show_mirroring %}
          <div class="ui labeled item">
              <div class="ui toggle checkbox">
                  {{ form.mirror_x(onchange='this.form.submit()') }}
                  <label></label>
              </div>
              <div class="top right aligned floating ui label">{{ _('Mirror X') }}</div>
          </div>
          <div class="ui labeled item">
              <div class="ui toggle checkbox">
                  {{ form.mirror_y(onchange='this.form.submit()') }}
                  <label></label>
              </div>
              <div class="top right aligned floating ui label">{{ _('Mirror Y') }}</div>
          </div>
      {% endif %}
      <input type="hidden" name="csrf_token" value="{{ csrf_token()|safe }}">
  </form>
{#
    <div style="width:800px;height:800px;overflow:hidden;">
        <button id="bOK">OK</button>​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​
        <img id="ichart" src="{{ url_for('main_deepskyobject.deepskyobject_fchart_img', dso_id=dso_id) }}"></img>
    </div>
#}
    <canvas id="fchart-canvas"></canvas>

    <script type="text/javascript">
        var labels = ["1", "3", "8", "20", "40"];
        $('#slider-field-size')
          .slider({
            min: 1,
            max: 5,
            step: 1,
            start:{{ form.radius.data }},
            fireOnInit: false,
            interpretLabel: function(value) {
              return labels[value];
            },
            onChange: function(value) {
                $('#radius').val(value);
                $("#fmchart" ).submit();
            }
          });

        $('.ui.dropdown').dropdown();

        $( '#decmag' ).click(function() {
            prev = +$('#maglim').val();
            $('#maglim').val(prev - 1);
            $('#fmchart' ).submit();
        });

        $( '#incmag' ).click(function() {
            prev = +$('#maglim').val();
            $('#maglim').val(prev + 1);
            $('#fmchart' ).submit();
        });

        $( '#decdsomag' ).click(function() {
            prev = +$('#dso_maglim').val();
            $('#dso_maglim').val(prev - 1);
            $('#fmchart' ).submit();
        });

        $( '#incdsomag' ).click(function() {
            prev = +$('#dso_maglim').val();
            $('#dso_maglim').val(prev + 1);
            $('#fmchart' ).submit();
        });

    </script>

    <script type="text/javascript">
        var canvas = document.getElementById('fchart-canvas');
        var ctx = canvas.getContext('2d');
        
        var skyImgBuf = [new Image(), new Image()];
        var skyImg = { active: 0, background: 1 };
        
        var legendImgBuf = [new Image(), new Image()];
        var legendImg = { active: 0, background: 1 };
        
        var isDragging = false
        var mouseX = 0;
        var mouseY = 0;
        var initialPinchDistance = null
        var dx = 0;
        var dy = 0;
        
        var fieldSizes = [{{ gui_field_sizes }}];
        
        var fldSizeIndexR = fieldSizes.length;
        var MAX_ZOOM = fldSizeIndexR + 0.4;
        var MIN_ZOOM = 0.5;
        var fldSizeIndex = fieldSizes.length - 1;
        
        var dso_ra = {{ dso.ra }};
        var dso_dec = {{ dso.dec }};
        
        var ra = dso_ra;
        var dec = dso_dec;
        
        var imgField = fieldSizes[fldSizeIndex];
        var scaleFac = 1.0;
        
        window.onload = function() {
            reloadLegendImage();
        }
        
        function redrawAll() {
            var curLegendImg = legendImgBuf[legendImg.active];
            var curSkyImg = skyImgBuf[skyImg.active];
            canvas.width = curLegendImg.width;
            canvas.height = curLegendImg.height;
            img_width = curSkyImg.width * scaleFac
            img_height = curSkyImg.height * scaleFac
            {% if chart_nm == '0' %}
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            {% else %}
                ctx.fillStyle = "black";
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            {% endif %}
            ctx.drawImage(curSkyImg, dx + (canvas.width-img_width)/2, dy + (canvas.height-img_height)/2, img_width, img_height);
            ctx.drawImage(curLegendImg, 0, 0);
        }
        
        window.addEventListener('resize', redrawAll, false);
        
        function reloadLegendImage() {
            var url = "{{ url_for('main_deepskyobject.deepskyobject_fchart_legend_img', dso_id=dso.id, ra='_RA_', dec='_DEC_', fsz='_FSZ_', mlim=chart_mlim, dlim=chart_dlim, nm=chart_nm, mx=chart_mx, my=chart_my) | safe }}";
            url = url.replace('_RA_', ra.toString());
            url = url.replace('_DEC_', dec.toString());
            url = url.replace('_FSZ_', fieldSizes[fldSizeIndex]);
            legendImgBuf[legendImg.background].onload = function() {
                legendImgBuf[legendImg.background].onload = null;
                var old = legendImg.active;
                legendImg.active = legendImg.background;
                legendImg.background = old;
                reloadImage();
            };
            legendImgBuf[legendImg.background].src = url;
        }
        
        function reloadImage() {
            var url = "{{ url_for('main_deepskyobject.deepskyobject_fchart_pos_img', dso_id=dso.id, ra='_RA_', dec='_DEC_', fsz='_FSZ_', mlim=chart_mlim, dlim=chart_dlim, nm=chart_nm, mx=chart_mx, my=chart_my) | safe }}";
            url = url.replace('_RA_', ra.toString());
            url = url.replace('_DEC_', dec.toString());
            url = url.replace('_FSZ_', fieldSizes[fldSizeIndex]);
            skyImgBuf[skyImg.background].onload = function() {
                skyImgBuf[skyImg.background].onload = null;
                var old = skyImg.active;
                skyImg.active = skyImg.background;
                skyImg.background = old;
                imgField = fieldSizes[fldSizeIndex];
                scaleFac = 1.0;
                redrawAll();
            };
            skyImgBuf[skyImg.background].src = url;
        } 

        function getEventLocation(e) {
            if (e.touches && e.touches.length == 1) {
                return { x:e.touches[0].clientX, y: e.touches[0].clientY }
            } else if (e.clientX && e.clientY) {
                return { x: e.clientX, y: e.clientY }        
            }
        }

        function onPointerDown(e) {
            isDragging = true
            mouseX = getEventLocation(e).x;
            mouseY = getEventLocation(e).y;
        }

        function onPointerUp(e) {
            if (isDragging) {
                dx += getEventLocation(e).x - mouseX;
                dy += getEventLocation(e).y - mouseY;
                
                fldSize = fieldSizes[fldSizeIndex];
                
                dec = dec + dy * Math.PI * fldSize / (180.0 * canvas.height);
                movDec = dec;
                
                if (dec > Math.PI / 2.0) dec = Math.PI/2.0;
                if (dec < -Math.PI / 2.0) dec = -Math.PI/2.0;
                
                if (movDec > Math.PI / 2.0 - Math.PI / 10.0) movDec = Math.PI / 2.0 - Math.PI / 10.0; 
                if (movDec < -Math.PI / 2.0 + Math.PI / 10.0) movDec = -Math.PI / 2.0 + Math.PI / 10.0; 

                ra = ra + dx * Math.PI * fldSize / (180.0 * canvas.width * Math.cos(movDec));
                if (ra > Math.PI*2) ra = ra - 2 * Math.PI 
                if (ra < 0) ra = ra + 2 * Math.PI

                reloadImage();

                dx = 0;
                dy = 0;
                isDragging = false
                initialPinchDistance = null
            }
        }

        function onPointerMove(e) {
            if (isDragging) {
                var x = dx + (getEventLocation(e).x-mouseX);
                var y = dy + (getEventLocation(e).y-mouseY);
                {% if chart_nm == '0' %}
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                {% else %}
                    ctx.fillStyle = "black";
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                {% endif %}
                var curSkyImg = skyImgBuf[skyImg.active];
                var curLegendImg = legendImgBuf[legendImg.active];
                ctx.drawImage(curSkyImg, x, y);
                ctx.drawImage(curLegendImg, 0, 0);
            }
        }

        function handleTouch(e, singleTouchHandler) {
            if ( e.touches.length == 1 ) {
                singleTouchHandler(e)
            } else if (e.type == "touchmove" && e.touches.length == 2) {
                isDragging = false
                handlePinch(e)
            }
        }

        function handlePinch(e) {
            e.preventDefault()
            
            var touch1 = { x: e.touches[0].clientX, y: e.touches[0].clientY }
            var touch2 = { x: e.touches[1].clientX, y: e.touches[1].clientY }
            
            // This is distance squared, but no need for an expensive sqrt as it's only used in ratio
            var currentDistance = (touch1.x - touch2.x)**2 + (touch1.y - touch2.y)**2
            
            if (initialPinchDistance == null) {
                initialPinchDistance = currentDistance
            } else {
                adjustZoom( null, currentDistance/initialPinchDistance )
            }
        }

        function adjustZoom(zoomAmount, zoomFactor) {
            if (!isDragging) {
                if (zoomAmount) {
                    fldSizeIndexR += zoomAmount
                } else if (zoomFactor) {
                    // console.log(zoomFactor)
                    fldSizeIndexR = zoomFactor*lastZoom
                }
                
                var oldFldSizeIndex = fldSizeIndex;
                
                fldSizeIndexR = Math.min( fldSizeIndexR, MAX_ZOOM )
                fldSizeIndexR = Math.max( fldSizeIndexR, MIN_ZOOM )
                
                fldSizeIndex = Math.round(fldSizeIndexR) - 1;
                
                if (fldSizeIndex != oldFldSizeIndex) {
                    scaleFac = imgField / fieldSizes[fldSizeIndex];  
                    redrawAll();
                    reloadLegendImage();
                    console.log(fldSizeIndex)
                }
            }
        }
        
        function normalizeDelta(wheelEvent) {
            var delta = 0;
            var wheelDelta = wheelEvent.wheelDelta;
            var deltaY = wheelEvent.deltaY;
            
            // CHROME WIN/MAC | SAFARI 7 MAC | OPERA WIN/MAC | EDGE
            if (wheelDelta) {
                delta = -wheelDelta / 120; 
            }
            // FIREFOX WIN / MAC | IE
            if(deltaY) {
                deltaY > 0 ? delta = 1 : delta = -1;
            }
            return delta;
        }
        
        canvas.addEventListener('mousedown', onPointerDown)
        canvas.addEventListener('touchstart', function(e) {
            handleTouch(e, onPointerDown);
        });
        canvas.addEventListener('mouseup', onPointerUp)
        canvas.addEventListener('touchend',  function(e) {
            handleTouch(e, onPointerUp);
        });
        canvas.addEventListener('mousemove', onPointerMove)
        canvas.addEventListener('touchmove', function(e) {
            handleTouch(e, onPointerMove);
            event.preventDefault();
        });
        canvas.addEventListener( 'wheel', function(e) {
            adjustZoom(normalizeDelta(e));
            event.preventDefault();
        });

    </script>
