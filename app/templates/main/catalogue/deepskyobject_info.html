{% extends 'layouts/base.html' %}
{% import 'macros/form_macros.html' as f %}

{% set endpoints = [
    ('main_deepskyobject.deepskyobject_info', 'Info', 'info'),
    ('main_deepskyobject.deepskyobject_findchart', 'Find chart', 'table'),
    ('main_deepskyobject.deepskyobject_aladin', 'Aladin', 'table'),
    ('main_deepskyobject.deepskyobject_catalogue_data', 'Catalogue data', 'table')
] %}

{% macro navigation(items) %}
    <div class="ui icon secondary pointing menu">
        {% for route, name, icon in items %}
            {% set href = url_for(route, dso_id=dso.id, from_constellation_id=from_constellation_id) %}
            <a class="item {% if request.endpoint == route %}active{% endif %}" href="{{ href }}">
                {{ name }}
            </a>
        {% endfor %}
        <div class="right menu" style="margin-bottom:0px;">
            <div class="item">
                <div class="ui mini multiple selection dropdown" style="float:right;">
                   <input type="hidden" name="plan">
                   <i class="dropdown icon"></i>
                   <div class="default mini text">Select plan</div>
                   <div class="menu">
                      <div class="item" data-value="wish"><i class="heart red icon"></i>wishlist</div>
                   </div>
                </div>
            </div>
        </div>
    </div>
{% endmacro %}

{# --- DSO Info --- #}
{% macro deepskyobject_info(dso, user_descr) %}
    <div id="items-fieldset" class="ui segments" data-toggle="fieldset">
        <div class="ui blue segment" style="display: inline-block;width:100%"">
            <h3>
                {% if user_descr and user_descr.common_name %} {{ user_descr.common_name }} {% else %}&nbsp;{% endif %}
                {% if editable %}
                    <a class="ui icon mini button" style="float:right;margin-left:10px;" href="{{ url_for('main_deepskyobject.deepskyobject_edit', dso_id=dso.id) }}">
                        <i class="caret edit icon"></i>
                    </a>
                {% endif %}
                {% if user_descr %}
                <div class="ui label" style="float:right;">
                    <div class="ui rating center mobile hidden" data-icon="star" data-rating="{{ user_descr.rating_to_int(5) }}" data-max-rating="5"></div>
                </div>
                {% endif %}
                <div class="ui label" style="float:right;">
                    <i class="info icon"></i> {{ dso.mag if dso.mag else dso.v_mag }}mag
                </div>
                {% if dso.constellation is not none %}
                <a class="ui label" style="float:right;" href="{{ url_for('main_constellation.constellation_info', constellation_id=dso.constellation.id) }}">
                    <i class="lastfm icon"></i> {{ dso.constellation.name.capitalize() }}
                </a>
                {% endif %}
            </h3>
            <div class="markdown">
                {% if user_descr %}
                    {% filter extended_commonmark(dso.name) %}
{{ user_descr.text  | safe}}
                    {% endfilter %}
                    {% for ap_class, app_descr in apert_descriptions %}
                        {% filter extended_commonmark(dso.name) %}
**{{ ap_class }}mm** - {{ app_descr }}
                        {% endfilter %}
                    {% endfor %}
                    {% filter extended_commonmark(dso.name) %}
{{ user_descr.references or '' }}
                    {% endfilter %}
                {% else %}
                    {{ deepskyobject_data_table(dso, False) }}
                {% endif %}
            </div>
        </div>
    </div>
{% endmacro %}

{# --- Find Chart --- #}
{% macro deepskyobject_fchart(dso, fchart) %}
    <form id="fmchart" action="{{ url_for('main_deepskyobject.deepskyobject_findchart', dso_id=dso.id) }}" method="post" class="ui menu">
        <!-- Field radius -->
        <div class="ui labeled item">
            <div class="ui labeled ticked small slider" id="slider-field-size" style="width:150px">
            </div>
            <input type="hidden" id="{{ form.radius.name }}" name="{{ form.radius.name }}" value="{{ form.radius.data }}">
            <div class="top right aligned floating ui label">{{ _('Field Size') }}</div>
        </div>
        <!-- Star mag limit -->
        <div class="ui labeled item">
            <div class="ui buttons">
                <button id="decmag" class="ui icon {{ disable_dec_mag }} button">
                    <i class="left chevron icon"></i>
                </button>
                <div class="ui icon dropdown button">
                    <input type="hidden" id="{{ form.maglim.name }}" name="{{ form.maglim.name }}" value="{{ form.maglim.data }}"
                            onchange="this.form.submit()">
                    <span class="text">{{ form.maglim.data }}</span>
                    <div class="menu">
                        {% for mag_item in range(mag_scale[0], mag_scale[1] + 1) %}
                            <div class="item">{{ mag_item }}</div>
                        {% endfor %}
                    </div>
                </div>
                <button id="incmag" class="ui right icon {{ disable_inc_mag }} button">
                    <i class="right chevron icon"></i>
                </button>
            </div>
            <div class="top right aligned floating ui label">{{ _('Limit mag') }}</div>
        </div>
        <!-- dso mag limit -->
        <div class="ui labeled item">
            <div class="ui buttons">
                <button id="decdsomag" class="ui icon {{ disable_dso_dec_mag }} button">
                    <i class="left chevron icon"></i>
                </button>
                <div class="ui icon dropdown button">
                    <input type="hidden" id="{{ form.dso_maglim.name }}" name="{{ form.dso_maglim.name }}" value="{{ form.dso_maglim.data }}"
                            onchange="this.form.submit()">
                    <span class="text">{{ form.dso_maglim.data }}</span>
                    <div class="menu">
                        {% for mag_item in range(dso_mag_scale[0], dso_mag_scale[1] + 1) %}
                            <div class="item">
                                {{ mag_item }}
                            </div>
                        {% endfor %}
                    </div>
                </div>
                <button id="incdsomag" class="ui right icon {{ disable_dso_inc_mag }} button">
                    <i class="right chevron icon"></i>
                </button>
            </div>
            <div class="top right aligned floating ui label">{{ _('DSO limit mag') }}</div>
        </div>
        {% if show_mirroring %}
            <div class="ui labeled item">
                <div class="ui toggle checkbox">
                    {{ form.mirror_x(onchange='this.form.submit()') }}
                    <label></label>
                </div>
                <div class="top right aligned floating ui label">{{ _('Mirror X') }}</div>
            </div>
            <div class="ui labeled item">
                <div class="ui toggle checkbox">
                    {{ form.mirror_y(onchange='this.form.submit()') }}
                    <label></label>
                </div>
                <div class="top right aligned floating ui label">{{ _('Mirror Y') }}</div>
            </div>
        {% endif %}
        <input type="hidden" name="csrf_token" value="{{ csrf_token()|safe }}">
    </form>
{% if show_pdf %}
    <canvas id="pdfcanvas"></canvas>
{% else %}
    <img src="{{fchart_url}}"></img>
{% endif %}
{% endmacro %}

{# --- Aladin lite --- #}
{% macro deepskyobject_aladin(dso) %}
    <link rel="stylesheet" href="https://aladin.u-strasbg.fr/AladinLite/api/v2/latest/aladin.min.css" />
    <!-- insert this snippet where you want Aladin Lite viewer to appear and after the loading of jQuery -->
    <div id="aladin-lite-div" style="width:100%;height:600px;"></div>
    <script type="text/javascript" src="https://aladin.u-strasbg.fr/AladinLite/api/v2/latest/aladin.min.js" charset="utf-8"></script>
    <script type="text/javascript">
        var aladin = A.aladin('#aladin-lite-div', {survey: "P/DSS2/color", fov:1, target: "{{ dso.ra_str_short().replace(':',' ')}} {{dso.dec_str_short().replace(':',' ')}}"});
    </script>
{% endmacro %}
{# --- Catalogue Data --- #}
{% macro deepskyobject_catalogue_data(dso, first_page) %}
    {% if first_page %}
        <div id="items-fieldset" class="ui segments" data-toggle="fieldset" style="width:100%">
            <div class="ui blue segment" style="display: inline-block; width:100%">
              <h3>&nbsp;
                  {% if editable %}
                      <a class="ui icon right floated mini button" href="{{ url_for('main_deepskyobject.deepskyobject_edit', dso_id=dso.id) }}">
                          <i class="caret edit icon"></i>
                      </a>
                  {% endif %}
                  {% if dso.v_mag %}
                      <div class="ui label" style="float:right;">
                          <i class="info icon"></i> {{ dso.v_mag }}mag
                      </div>
                  {% endif %}
                  {% if dso.constellation %}
                  <a class="ui label" style="float:right;" href="{{ url_for('main_constellation.constellation_info', constellation_id=dso.constellation.id) }}">
                      <i class="lastfm icon"></i> {{ dso.constellation.name.capitalize() }}
                  </a>
                  {% endif %}
              </h3>
    {% endif %}
    {{ deepskyobject_data_table(dso, True) }}
    {% if first_page %}
            </div>
        </div>
    {% endif %}
{% endmacro %}

{% macro deepskyobject_data_table(dso, full_table) %}
    {% if dso_image_info %}
        {% if dso_image_info[1] %}
            <figure class="md-fig-left">
                <img src="{{ dso_image_info[0] }}"/>
                <figcaption>{{ dso_image_info[1] | safe }}</figcaption>
            </figure>
        {% else %}
            <img class="ui left floated image" src="{{ dso_image_info[0] }}"/>
        {% endif %}
        <table>
    {% else %}
        <table class="ui compact definition table">
    {% endif %}
        {% if full_table %}<tr><td>{{ _('Name') }}</td><td>{{ dso.denormalized_name() }}</td></tr>{% endif %}
        <tr><td>{{ _('Type') }}</td><td>{{ dso.type }}</td></tr>
        {% if dso.common_name %}<tr><td>{{ _('Common name') }}</td><td>{{ dso.common_name }}</td></tr>{% endif %}
        {% if full_table %}<tr><td>{{ _('Constellation') }}</td><td>{{ dso.constellation.name.capitalize() if dso.constellation else '' }}</td></tr>{% endif %}
        {% if dso.descr %}<tr><td>{{ _('descr') }}</td><td>{{ dso.descr }}</td></tr>{% endif %}
        <tr><td>RA</td><td>{{ dso.ra_str() }}</td></tr>
        <tr><td>Dec</td><td>{{ dso.dec_str() }}</td></tr>
        {% if dso.major_axis %}<tr><td>major_axis</td><td>{{ dso.major_axis }}'</td></tr>{% endif %}
        {% if dso.minor_axis %}<tr><td>minor_axis</td><td>{{ dso.minor_axis }}'</td></tr>{% endif %}
        {% if dso.positon_angle %}<tr><td>positon_angle</td><td>{{ dso.positon_angle }}</td></tr>{% endif %}
        {% if dso.mag %}<tr><td>mag</td><td>{{ dso.mag }}</td></tr>{% endif %}
        {% if dso.b_mag %}<tr><td>b_mag</td><td>{{ dso.b_mag }}</td></tr>{% endif %}
        {% if dso.v_mag %}<tr><td>v_mag</td><td>{{ dso.v_mag }}</td></tr>{% endif %}
        {% if dso.j_mag %}<tr><td>j_mag</td><td>{{ dso.j_mag }}</td></tr>{% endif %}
        {% if dso.h_mag %}<tr><td>h_mag</td><td>{{ dso.h_mag }}</td></tr>{% endif %}
        {% if dso.k_mag %}<tr><td>k_mag</td><td>{{ dso.k_mag }}</td></tr>{% endif %}
        {% if dso.surface_bright %}<tr><td>surface_bright</td><td>{{ dso.surface_bright }}</td></tr>{% endif %}
        {% if dso.minor_axis %}<tr><td>minor_axis</td><td>{{ dso.minor_axis }}</td></tr>{% endif %}
        {% if dso.hubble_type %}<tr><td>hubble_type</td><td>{{ dso.hubble_type }}</td></tr>{% endif %}
        {% if dso.type == 'PN' %}
            {% if dso.c_star_u_mag %}<tr><td>c_star_u_mag</td><td>{{ dso.c_star_u_mag }}</td></tr>{% endif %}
            {% if dso.c_star_b_mag %}<tr><td>c_star_b_mag</td><td>{{ dso.c_star_b_mag }}</td></tr>{% endif %}
            {% if dso.c_star_v_mag %}<tr><td>c_star_v_mag</td><td>{{ dso.c_star_v_mag }}</td></tr>{% endif %}
        {% endif %}

        {# <tr><td>identifiers</td><td>{{ dso.identifiers }}</td></tr> #}
    </table>
{% endmacro %}

{% block content %}
    <div class="ui stackable centered grid container">
        <div class="fourteen wide tablet sixteen wide computer centered column">
            <div>
                <div class="ui huge breadcrumb">
                {% if from_constellation_id %}
                    <a class="ui basic compact button" href="{{ url_for('main_constellation.constellation_info', constellation_id=from_constellation_id) }}#dso{{dso.id}}">
                        <i class="caret left icon"></i>
                        {{ _('Constellation') }}
                    </a>
                {% elif from_observation_id %}
                    <a class="ui basic compact button" href="{{ url_for('main_observation.observation_info', observation_id=from_observation_id) }}#dso{{dso.id}}">
                        <i class="caret left icon"></i>
                        {{ _('Observation') }}
                    </a>
                {% elif from_wishlist %}
                    <a class="ui basic compact button" href="{{ url_for('main_planner.wish_list') }}#dso{{dso.id}}">
                        <i class="caret left icon"></i>
                        {{ _('Wishlist') }}
                    </a>
                {% elif from_session_plan and session_plan_id %}
                    <a class="ui basic compact button" href="{{ url_for('main_planner.session_plan_info', session_plan_id=session_plan_id) }}#dso{{dso.id}}">
                        <i class="caret left icon"></i>
                        {{ _('Session Plan') }}
                    </a>
                {% else %}
                    <a class="ui basic compact button" href="{{ url_for('main_deepskyobject.deepskyobjects', back=1)}}">
                        <i class="caret left icon"></i>
                        {{ _('DSO list') }}
                    </a>
                {% endif %}
                <div class="divider"> / </div>
                <div class="active section">
                    {{ dso.denormalized_name() }}
                </div>
            </div>
            {% if next_dso %}
                <a class="ui basic compact right floated button" href="{{ url_for('main_deepskyobject.deepskyobject_info', dso_id=next_dso.id, sel_tab=type)}}">
                    {{ next_dso.catalog_number() }}
                    <i class="caret right icon"></i>
                </a>
            {% endif %}
            {% if prev_dso %}
                <a class="ui basic compact right floated button" href="{{ url_for('main_deepskyobject.deepskyobject_info', dso_id=prev_dso.id, sel_tab=type)}}">
                    <i class="caret left icon"></i>
                    {{ prev_dso.catalog_number() }}
                </a>
            {% endif %}
            </div>

            {{ navigation(endpoints) }}

            {% if type == 'info' %}
                {% if dso_image_info or descr_available %}
                    {{ deepskyobject_info(dso, user_descr) }}
                {% else %}
                    {{ deepskyobject_catalogue_data(dso, True) }}
                {% endif %}
            {% elif type == 'fchart' %}
                {{ deepskyobject_fchart(dso, fchart) }}
            {% elif type == 'aladin' %}
                {{ deepskyobject_aladin(dso) }}
            {% elif type == 'catalogue_data' %}
                {{ deepskyobject_catalogue_data(dso, False) }}
            {% endif %}
        </div>
  </div>
    <script type="text/javascript">
        $('.ui.rating')
        .rating();
    </script>
    <style>
.markdown img {
  max-width: 100%;
  height: auto;
}
.markdown p {
  text-align: justify;
}
    </style>
    {% if type == 'fchart' %}
        <script src="//mozilla.github.io/pdf.js/build/pdf.js"></script>

        <script type="text/javascript">
            var labels = ["1", "3", "8", "20"];
            $('#slider-field-size')
              .slider({
                min: 1,
                max: 4,
                step: 1,
                start:{{ form.radius.data }},
                fireOnInit: false,
                interpretLabel: function(value) {
                  return labels[value];
                },
                onChange: function(value) {
                    $('#radius').val(value);
                    $("#fmchart" ).submit();
                }
              });

            $('.ui.dropdown').dropdown();

            $( '#decmag' ).click(function() {
                prev = +$('#maglim').val();
                $('#maglim').val(prev - 1);
                $('#fmchart' ).submit();
            });

            $( '#incmag' ).click(function() {
                prev = +$('#maglim').val();
                $('#maglim').val(prev + 1);
                $('#fmchart' ).submit();
            });

            $( '#decdsomag' ).click(function() {
                prev = +$('#dso_maglim').val();
                $('#dso_maglim').val(prev - 1);
                $('#fmchart' ).submit();
            });

            $( '#incdsomag' ).click(function() {
                prev = +$('#dso_maglim').val();
                $('#dso_maglim').val(prev + 1);
                $('#fmchart' ).submit();
            });

{% if show_pdf %}
            var url = '{{fchart_url}}';

            var pdfjsLib = window['pdfjs-dist/build/pdf'];

            pdfjsLib.GlobalWorkerOptions.workerSrc = '//mozilla.github.io/pdf.js/build/pdf.worker.js';

            var loadingTask = pdfjsLib.getDocument(url);
            loadingTask.promise.then(function(pdf) {
            console.log('PDF loaded');

            var pageNumber = 1;
            pdf.getPage(pageNumber).then(function(page) {
                console.log('Page loaded');

                var scale = 1.5;
                var viewport = page.getViewport({scale: scale});

                // Prepare canvas using PDF page dimensions
                var canvas = document.getElementById('pdfcanvas');
                var context = canvas.getContext('2d');
                canvas.height = viewport.height;
                canvas.width = viewport.width;

                // Render PDF page into canvas context
                var renderContext = {
                canvasContext: context,
                viewport: viewport
                };
                var renderTask = page.render(renderContext);
                renderTask.promise.then(function () {
                console.log('Page rendered');
                });
            });
            }, function (reason) {
            // PDF loading error
                console.error(reason);
            });
{% endif %}

        </script>

    {% endif %}
{% endblock %}
